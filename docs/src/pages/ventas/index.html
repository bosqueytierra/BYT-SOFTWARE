<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ventas - BYT SOFTWARE</title>
  <link rel="stylesheet" href="../../styles/global.css">
  <style>
    :root {
      --bg: #f6f7f8;
      --card: #ffffff;
      --border: #e4e7eb;
      --text: #2d2d2d;
      --muted: #6c7a86;
      --primary: #2e5e4e;
      --primary-soft: #3f705d;
      --danger: #c0392b;
      --shadow: 0 6px 16px rgba(0,0,0,0.06);
      --selected: #e9f2ed;
    }
    body { margin:0; font-family:"Inter","SF Pro Display","Roboto",system-ui,sans-serif; background:var(--bg); color:var(--text); }
    /* ancho m√°s amplio */
    .page { max-width: 1480px; margin: 22px auto 48px; padding: 0 20px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; box-shadow: var(--shadow); }
    .card + .card { margin-top: 14px; }
    .header-card { display:flex; justify-content:space-between; gap:12px; align-items:center; }
    .filters { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; align-items:end; }
    label { font-size:13px; color:var(--muted); font-weight:600; margin-bottom:6px; display:block; }
    input, select {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px;
      background: #fdfdfd; font-family: inherit; font-size: 14px;
    }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align:left; font-size:14px; }
    th { color: var(--muted); font-weight:700; background: #fafafa; }
    tr.project-row { cursor:pointer; transition: background 0.15s ease; }
    tr.project-row:hover { background: #f5f8f7; }
    tr.project-row.selected { background: var(--selected); }
    .actions { display:flex; gap:8px; flex-wrap:nowrap; }
    .btn { border:1px solid var(--border); background:#fff; color:#1f2430; padding:9px 12px; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px; display:inline-flex; align-items:center; gap:6px; }
    .btn-ghost { background:#f0f3f5; color:#1f2430; }
    .layout-grid { display:grid; grid-template-columns: 2fr 1fr; gap:14px; align-items:start; }
    @media (max-width: 1100px) { .layout-grid { grid-template-columns: 1fr; } }
    .empty { padding:14px; color:var(--muted); text-align:center; }
    .state-icon { font-size:20px; display:inline-block; margin-right:6px; }
    .money { font-weight:700; color:var(--primary); }
    .table-title { margin:0 0 8px; font-size:16px; font-weight:800; }
    .subtext { color:var(--muted); font-size:13px; margin:0 0 8px; }
    .note-indicator { font-size:12px; color:var(--muted); display:inline-block; margin-left:6px; }
    select.state-select, select.project-state {
      min-width: 150px;
    }
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.35);
      display: none; align-items: center; justify-content: center; z-index: 12000; padding: 16px;
    }
    .modal {
      background: #fff; border-radius: 14px; border: 1px solid var(--border);
      box-shadow: 0 16px 40px rgba(0,0,0,0.12); width: min(520px, 100%); padding: 18px;
    }
    .modal h3 { margin: 0 0 8px; }
    .modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; flex-wrap:wrap; }
    textarea { width:100%; min-height:140px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-family:inherit; font-size:14px; background:#fdfdfd; }
  </style>
</head>
<body>
  <div class="page">
    <div class="card header-card">
      <div>
        <h2 style="margin:0;">Ventas</h2>
        <p style="margin:2px 0 0; color:var(--muted); font-size:13px;">Cotizaciones aprobadas. Selecciona un proyecto para ver sus partidas.</p>
      </div>
      <div class="actions">
        <a class="btn btn-ghost" href="dashboard.html">Ir a Dashboard</a>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;">Filtros</h3>
      <div class="filters">
        <div>
          <label>Buscar por proyecto o partida</label>
          <input id="filtro-texto" type="text" placeholder="Proyecto o partida..." oninput="aplicarFiltros()">
        </div>
        <div>
          <label>Estado</label>
          <select id="filtro-estado" onchange="aplicarFiltros()">
            <option value="todos">Todos</option>
            <option value="en_ejecucion">En ejecuci√≥n</option>
            <option value="completada">Completada</option>
            <option value="cancelada">Cancelada</option>
            <option value="postventa">Postventa</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;">Proyectos</h3>
      <p class="subtext">Selecciona un proyecto para ver sus partidas.</p>
      <div id="proyectos-wrapper"></div>
    </div>

    <div class="layout-grid">
      <div class="card">
        <h3 class="table-title" id="partidas-title">Partidas del proyecto</h3>
        <p class="subtext" id="partidas-subtitle">Selecciona un proyecto para ver sus partidas.</p>
        <div id="partidas-wrapper"></div>
      </div>
      <div class="card">
        <h3 class="table-title" id="resumen-title">Resumen</h3>
        <div id="resumen-wrapper"></div>
      </div>
    </div>
  </div>

  <!-- Modal de notas -->
  <div class="modal-backdrop" id="notes-modal">
    <div class="modal">
      <h3 id="notes-title">Notas</h3>
      <textarea id="notes-textarea" placeholder="Escribe observaciones..."></textarea>
      <div class="modal-actions">
        <button class="btn btn-ghost" type="button" onclick="closeNotesModal()">Cancelar</button>
        <button class="btn btn-primary" type="button" onclick="saveNotes()">Guardar</button>
      </div>
    </div>
  </div>

  <script src="../../js/layout.js"></script>
  <script src="../../lib/supabaseConfig.js"></script>
  <script type="module" src="../../js/supabaseBrowserClient.js"></script>
  <script src="../../js/globalSupabase.js" defer></script>

  <script>
    const ESTADOS = ['en_ejecucion','completada','cancelada','postventa'];
    let ventasData = [];
    let ventasFiltradas = [];
    let proyectos = [];
    let selectedProyectoKey = null;
    const notesStore = new Map();
    let notesModalState = { partidaId: null, proyectoKey: null };

    document.addEventListener('DOMContentLoaded', async () => { await cargarVentas(); });

    async function cargarVentas() {
      const pw = document.getElementById('proyectos-wrapper');
      pw.innerHTML = '<div class="empty"><span class="state-icon">‚è≥</span>Cargando ventas...</div>';
      try {
        if (window.supabaseClient?.init) await window.supabaseClient.init();
        const res = await window.supabaseClient.listarVentas();
        if (!res.success) throw new Error(res.error);
        ventasData = res.data || [];
        ventasFiltradas = ventasData;
        aplicarFiltros();
      } catch (e) {
        console.error(e);
        pw.innerHTML = '<div class="empty"><span class="state-icon">‚ö†Ô∏è</span>Error cargando ventas</div>';
      }
    }

    function aplicarFiltros() {
      const txt = document.getElementById('filtro-texto').value.toLowerCase().trim();
      const est = document.getElementById('filtro-estado').value;
      ventasFiltradas = ventasData.filter(v => {
        const matchTxt = !txt ||
          (v.proyecto || '').toLowerCase().includes(txt) ||
          (v.partida_nombre || v.partida || '').toLowerCase().includes(txt);
        const matchEst = est === 'todos' ? true : (v.estado || 'en_ejecucion') === est;
        return matchTxt && matchEst;
      });
      buildProyectos();
      renderProyectos();
      renderPartidas();
      renderResumen();
    }

    function buildProyectos() {
      const map = new Map();
      ventasFiltradas.forEach(v => {
        const key = v.proyecto || 'Sin proyecto';
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(v);
      });
      proyectos = Array.from(map.entries()).map(([key, items]) => {
        const totalCobrado = items.reduce((acc, it) => acc + (Number(it.total_venta || 0) || 0), 0);
        const totalCotizado = items.reduce((acc, it) => acc + (Number(it.total_cotizado || 0) || 0), 0);
        const estado = items[0]?.estado || 'en_ejecucion';
        const cliente = formatCliente(items[0]?.cliente);
        const fechaCierre = items[0]?.fecha_aprobacion || items[0]?.fecha_cierre || items[0]?.fecha_cierre_max || '';
        const cotizacionId = items[0]?.cotizacion_id;
        const proyectoId = items[0]?.proyecto_id || key;
        return { key, proyectoId, cotizacionId, cliente, estado, fechaCierre, totalCobrado, totalCotizado, items };
      });
      if (!selectedProyectoKey && proyectos.length) {
        selectedProyectoKey = proyectos[0].key;
      }
      if (selectedProyectoKey && !proyectos.find(p => p.key === selectedProyectoKey)) {
        selectedProyectoKey = null;
      }
    }

    function renderProyectos() {
      const pw = document.getElementById('proyectos-wrapper');
      if (!proyectos.length) {
        pw.innerHTML = '<div class="empty"><span class="state-icon">üìÅ</span>No hay proyectos</div>';
        return;
      }
      const rows = proyectos.map(p => {
        const isSel = p.key === selectedProyectoKey;
        return `
          <tr class="project-row ${isSel ? 'selected':''}" onclick="selectProyecto('${escapeHtmlAttr(p.key)}')">
            <td>${escapeHtml(p.key)}</td>
            <td>${p.fechaCierre ? escapeHtml(formatDate(p.fechaCierre)) : '-'}</td>
            <td>${escapeHtml(p.cliente || '')}</td>
            <td>${escapeHtml(fmt(p.totalCotizado))}</td>
            <td>${escapeHtml(fmt(p.totalCobrado))}</td>
            <td>
              <select class="project-state" onmousedown="event.stopPropagation();" onchange="handleEstadoProyectoChange(event, '${escapeHtmlAttr(p.cotizacionId || '')}', '${escapeHtmlAttr(p.key)}')">
                ${ESTADOS.map(st => `<option value="${st}" ${p.estado===st?'selected':''}>${labelEstado(st)}</option>`).join('')}
              </select>
            </td>
            <td>
              <div class="actions">
                <button class="btn btn-ghost" onclick="event.stopPropagation(); verAdjuntos('${escapeHtmlAttr(p.cotizacionId || '')}')">Adjuntos</button>
                <button class="btn btn-ghost" onclick="event.stopPropagation(); verCotizacion('${escapeHtmlAttr(p.cotizacionId || '')}')">Ver Cotizaci√≥n</button>
                <button class="btn btn-ghost" onclick="event.stopPropagation(); imprimirContrato('${escapeHtmlAttr(p.cotizacionId || '')}')">Imprimir contrato</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      pw.innerHTML = `
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Nombre proyecto</th>
                <th>Fecha de cierre</th>
                <th>Cliente</th>
                <th>Precio cotizado</th>
                <th>Precio cobrado</th>
                <th>Status</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function renderPartidas() {
      const pw = document.getElementById('partidas-wrapper');
      const title = document.getElementById('partidas-title');
      const subtitle = document.getElementById('partidas-subtitle');

      if (!selectedProyectoKey) {
        title.textContent = 'Partidas del proyecto';
        subtitle.textContent = 'Selecciona un proyecto para ver sus partidas.';
        pw.innerHTML = '<div class="empty"><span class="state-icon">‚ÑπÔ∏è</span>Selecciona un proyecto para ver sus partidas.</div>';
        return;
      }

      const proyecto = proyectos.find(p => p.key === selectedProyectoKey);
      if (!proyecto) {
        title.textContent = 'Partidas del proyecto';
        subtitle.textContent = 'Selecciona un proyecto para ver sus partidas.';
        pw.innerHTML = '<div class="empty"><span class="state-icon">‚ÑπÔ∏è</span>Selecciona un proyecto para ver sus partidas.</div>';
        return;
      }

      title.textContent = `Partidas del proyecto: ${proyecto.key}`;
      subtitle.textContent = `${proyecto.items.length} partida(s)`;

      if (!proyecto.items.length) {
        pw.innerHTML = '<div class="empty"><span class="state-icon">üìÅ</span>Este proyecto no tiene partidas.</div>';
        return;
      }

      const rows = proyecto.items.map(item => {
        const partidaId = item.id || item.partida_id || item.partida_nombre || item.partida;
        const nota = notesStore.get(partidaId) || '';
        return `
          <tr>
            <td>${escapeHtml(item.partida_nombre || item.partida || 'Partida')}</td>
            <td><input type="date" value="${item.fecha_venta_partida || ''}" onchange="handlePartidaInput('${escapeHtmlAttr(partidaId)}','fecha_venta_partida', this.value)"></td>
            <td><input type="date" value="${item.fecha_instalacion || ''}" onchange="handlePartidaInput('${escapeHtmlAttr(partidaId)}','fecha_instalacion', this.value)"></td>
            <td><input type="number" min="0" step="1000" value="${Number(item.precio_individual_estimado||0)}" onchange="handlePartidaInput('${escapeHtmlAttr(partidaId)}','precio_individual_estimado', this.value)"></td>
            <td>
              <button class="btn btn-ghost" onclick="openNotesModal('${escapeHtmlAttr(partidaId)}','${escapeHtmlAttr(selectedProyectoKey)}')">Notas</button>
              ${nota ? `<span class="note-indicator">üìù</span>` : ''}
            </td>
            <td>
              <select class="state-select" onmousedown="event.stopPropagation();" onchange="handleEstadoPartidaChange(event, '${escapeHtmlAttr(partidaId)}', '${escapeHtmlAttr(item.cotizacion_id || proyecto.cotizacionId || '')}')">
                ${ESTADOS.map(st => `<option value="${st}" ${item.estado===st?'selected':''}>${labelEstado(st)}</option>`).join('')}
              </select>
            </td>
          </tr>
        `;
      }).join('');

      pw.innerHTML = `
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Nombre partida</th>
                <th>Fecha de venta</th>
                <th>Fecha de instalaci√≥n</th>
                <th>Precio individual estimado</th>
                <th>Notas y obs</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function renderResumen() {
      const rw = document.getElementById('resumen-wrapper');
      const title = document.getElementById('resumen-title');

      if (!selectedProyectoKey) {
        title.textContent = 'Resumen';
        rw.innerHTML = '<div class="empty"><span class="state-icon">‚ÑπÔ∏è</span>Selecciona un proyecto para ver el resumen.</div>';
        return;
      }
      const proyecto = proyectos.find(p => p.key === selectedProyectoKey);
      if (!proyecto) {
        title.textContent = 'Resumen';
        rw.innerHTML = '<div class="empty"><span class="state-icon">‚ÑπÔ∏è</span>Selecciona un proyecto para ver el resumen.</div>';
        return;
      }
      title.textContent = `Resumen del proyecto: ${proyecto.key}`;

      const subtotal = proyecto.items.reduce((acc, it) => acc + (Number(it.precio_individual_estimado || 0) || 0), 0);
      const iva = subtotal * 0.19;
      const total = subtotal + iva;

      rw.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:8px; font-size:14px;">
          <div style="display:flex; justify-content:space-between;"><span>Subtotal</span><span class="money">${escapeHtml(fmt(subtotal))}</span></div>
          <div style="display:flex; justify-content:space-between;"><span>IVA (19%)</span><span class="money">${escapeHtml(fmt(iva))}</span></div>
          <hr style="border:none; border-top:1px solid var(--border);">
          <div style="display:flex; justify-content:space-between; font-weight:800; font-size:15px;"><span>Total</span><span class="money">${escapeHtml(fmt(total))}</span></div>
        </div>
      `;
    }

    function selectProyecto(key) {
      selectedProyectoKey = key;
      renderProyectos();
      renderPartidas();
      renderResumen();
    }

    function labelEstado(st) {
      switch(st) {
        case 'en_ejecucion': return 'En ejecuci√≥n';
        case 'completada': return 'Completada';
        case 'cancelada': return 'Cancelada';
        case 'postventa': return 'Postventa';
        default: return st;
      }
    }

    function fmt(num) {
      if (num === null || num === undefined) return '$0';
      return new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 }).format(num);
    }
    function formatCliente(cli) {
      if (!cli) return '';
      if (typeof cli === 'string') {
        try {
          const o = JSON.parse(cli);
          return o.nombre || o.name || o.cliente || '';
        } catch { return cli; }
      }
      if (typeof cli === 'object') return cli.nombre || cli.name || cli.cliente || '';
      return String(cli);
    }
    function formatDate(d) { try { return new Date(d).toLocaleDateString('es-CL'); } catch { return ''; } }

    async function handleEstadoProyectoChange(e, cotizacionId, key) {
      e.stopPropagation();
      const nuevoEstado = e.target.value;
      const proyecto = proyectos.find(p => p.key === key);
      if (!proyecto) return;
      const prev = proyecto.estado;
      try {
        if (window.supabaseClient?.init) await window.supabaseClient.init();
        const res = await window.supabaseClient.actualizarEstadoVentaPorCotizacion(cotizacionId, nuevoEstado);
        if (!res.success) throw new Error(res.error || 'No se pudo actualizar estado');
        ventasData = ventasData.map(v => (v.proyecto === proyecto.key) ? { ...v, estado: nuevoEstado } : v);
        aplicarFiltros();
        window.utils?.mostrarNotificacion?.('Estado del proyecto actualizado', 'success');
      } catch (err) {
        console.error(err);
        window.utils?.mostrarNotificacion?.('No se pudo actualizar estado: ' + (err.message || err), 'error');
        e.target.value = prev;
      }
    }

    async function handleEstadoPartidaChange(e, partidaId, cotizacionId) {
      const nuevoEstado = e.target.value;
      const prev = (ventasData.find(v => (v.id || v.partida_id || v.partida_nombre || v.partida) === partidaId) || {}).estado || 'en_ejecucion';
      try {
        if (window.supabaseClient?.init) await window.supabaseClient.init();
        const res = await window.supabaseClient.actualizarEstadoVentaPorCotizacion(cotizacionId, nuevoEstado);
        if (!res.success) throw new Error(res.error || 'No se pudo actualizar estado');
        ventasData = ventasData.map(v => {
          const idv = v.id || v.partida_id || v.partida_nombre || v.partida;
          return idv === partidaId ? { ...v, estado: nuevoEstado } : v;
        });
        aplicarFiltros();
        window.utils?.mostrarNotificacion?.('Estado de la partida actualizado', 'success');
      } catch (err) {
        console.error(err);
        window.utils?.mostrarNotificacion?.('No se pudo actualizar estado: ' + (err.message || err), 'error');
        e.target.value = prev;
      }
    }

    function handlePartidaInput(partidaId, field, value) {
      ventasData = ventasData.map(v => {
        const idv = v.id || v.partida_id || v.partida_nombre || v.partida;
        if (idv === partidaId) {
          return { ...v, [field]: field === 'precio_individual_estimado' ? Number(value || 0) : value };
        }
        return v;
      });
      aplicarFiltros();
    }

    function verCotizacion(id) { if (!id) return; window.location.href = `../cotizaciones/detalle.html?id=${id}`; }
    function verAdjuntos(id) { if (!id) return; window.location.href = `../cotizaciones/detalle.html?id=${id}#adjuntos`; }
    function imprimirContrato(id) { window.utils?.mostrarNotificacion?.('Imprimir contrato a√∫n no est√° disponible', 'info'); }

    // Modal notas
    function openNotesModal(partidaId, proyectoKey) {
      notesModalState = { partidaId, proyectoKey };
      const modal = document.getElementById('notes-modal');
      const textarea = document.getElementById('notes-textarea');
      const title = document.getElementById('notes-title');
      const partida = ventasData.find(v => (v.id || v.partida_id || v.partida_nombre || v.partida) === partidaId);
      const nombrePartida = partida?.partida_nombre || partida?.partida || 'Partida';
      title.textContent = `Notas - ${nombrePartida}`;
      textarea.value = notesStore.get(partidaId) || '';
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function closeNotesModal() {
      const modal = document.getElementById('notes-modal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      notesModalState = { partidaId: null, proyectoKey: null };
    }
    function saveNotes() {
      const { partidaId } = notesModalState;
      if (!partidaId) { closeNotesModal(); return; }
      const textarea = document.getElementById('notes-textarea');
      const text = textarea.value.trim();
      notesStore.set(partidaId, text);
      closeNotesModal();
      renderPartidas();
    }

    function escapeHtml(str) {
      if (str === undefined || str === null) return '';
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeHtmlAttr(str) { return escapeHtml(str).replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }
  </script>
</body>
</html>
