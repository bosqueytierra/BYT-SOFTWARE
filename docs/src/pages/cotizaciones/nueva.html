<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Cotización - BYT SOFTWARE</title>
    <link rel="stylesheet" href="../../styles/global.css">

        <!-- aca añadí esto -->
<style>
  .step-nav {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    margin: 12px 0 4px 0;
    padding: 4px 2px;
  }
  .step-chip {
    border: 1px solid #d9e3dd;
    background: #f7faf8;
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
    white-space: nowrap;
    font-size: 12px;
    color: #2e5e4e;
    transition: 0.15s;
  }
  .step-chip:hover { background: #e9f2ed; }
  .step-chip.active {
    background: #2e5e4e;
    color: #fff;
    border-color: #2e5e4e;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  }
</style>



    
</head>
<body>
    <a href="../menu_principal.html" class="btn-back">← Atrás</a>
    
    <!-- Barra de Resumen Superior -->
    <div class="summary-bar">
        <div class="summary-grid">
            <div class="summary-item">
                <span class="summary-label">Total Materiales</span>
                <span class="summary-value" id="total-materiales">$0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Factor</span>
                <span class="summary-value" id="factor-valor">1.3x</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Neto</span>
                <span class="summary-value" id="neto-valor">$0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">IVA (19%)</span>
                <span class="summary-value" id="iva-valor">$0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Total Proyecto</span>
                <span class="summary-value" id="total-proyecto">$0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Ganancia</span>
                <span class="summary-value" id="ganancia-valor">$0</span>
            </div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <img src="../../assets/logo_byt.png" alt="Logo BYT" class="logo">
                    <div>
                        <h1 class="header-title">Nueva Cotización</h1>
                        <p class="header-subtitle">Wizard de 14 Pasos - Bosque y Tierra</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Barra de Progreso -->
        <div class="wizard-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progreso-barra" style="width:0%;"></div>
            </div>
            <div class="step-info" id="progreso-texto">
                <span>Paso 1 de 10</span>
                <span><strong>Datos del Cliente</strong></span>
            </div>
        </div>

<!-- Lo agreré yo, son los link supuestamente -->
    <div class="step-nav" id="step-nav"></div>


        
        <!-- Contenedor del Wizard -->
        <div class="wizard-container">
            <!-- Paso 1: Datos del Cliente -->
            <div id="paso-1" class="wizard-step">
                <!-- Se genera dinámicamente -->
            </div>

            <!-- Paso 2: Quincallería -->
            <div id="paso-2" class="wizard-step" style="display: none;">
                <!-- Se genera dinámicamente -->
            </div>

            <!-- Paso 3: Tableros -->
            <div id="paso-3" class="wizard-step" style="display: none;">
                <!-- Se genera dinámicamente -->
            </div>

            <!-- Paso 4: Tapacantos -->
            <div id="paso-4" class="wizard-step" style="display: none;">
                <!-- Se genera dinámicamente -->
            </div>

            <!-- Paso 5: Tableros de Madera -->
            <div id="paso-5" class="wizard-step" style="display: none;">
                <!-- Se genera dinámicamente -->
            </div>

            <!-- Paso 6: LED y Electricidad -->
            <div id="paso-6" class="wizard-step" style="display: none;">
                <!-- Se genera dinámicamente -->
            </div>

            <!-- Paso 7: Otras Compras -->
            <div id="paso-7" class="wizard-step" style="display: none;">
                <!-- Se genera dinámicamente -->
            </div>

            <!-- Paso 8: Valores Traspasados -->
            <div id="paso-8" class="wizard-step" style="display: none;">
                <!-- Se genera dinámicamente -->
            </div>

            <!-- Paso 9: Factor General -->
            <div id="paso-9" class="wizard-step" style="display: none;">
                <!-- Se genera dinámicamente -->
            </div>

            <!-- Paso 10: Resumen Final -->
            <div id="paso-10" class="wizard-step" style="display: none;">
                <!-- Se genera dinámicamente -->
            </div>
        </div>

        <!-- Botones de Navegación -->
        <div class="card" style="text-align: center; margin-top: 30px;">
            <button type="button" class="btn btn-secondary" id="btn-anterior" onclick="anteriorPaso()">
                ← Anterior
            </button>
            <button type="button" class="btn" id="btn-siguiente" onclick="siguientePaso()" style="margin-left: 15px;">
                Siguiente →
            </button>
        </div>
    </div>

    <!-- Config Supabase: URL y ANON key -->
    <script src="../../lib/supabaseConfig.js"></script>

    <!-- Inicializador que crea window.supabase y emite supabase:ready -->
    <script type="module" src="../../js/supabaseBrowserClient.js"></script>

    <!-- Librería globalSupabase (usa el cliente ya creado) -->
    <script src="../../js/globalSupabase.js" defer></script>

    <!-- Resto de dependencias -->
    <script src="../../js/categorias_reales.js" defer></script>
    <script src="../../js/wizard.js" defer></script>

    <script>
        // Verificar autenticación
        if (!localStorage.getItem('byt_logged_in')) {
            window.location.href = '../login/login.html';
        }

        // Inicializar Supabase al cargar la página (usará globalSupabase.js)
        window.addEventListener('load', async () => {
            try {
                if (window.supabaseClient && typeof window.supabaseClient.validarConexion === 'function') {
                    const conexionOk = await window.supabaseClient.validarConexion();
                    if (!conexionOk) {
                        console.warn('Conexión con Supabase no disponible - funcionando en modo offline');
                        window.utils?.mostrarNotificacion?.('Trabajando en modo offline', 'warning');
                    }
                } else {
                    console.warn('supabaseClient no está disponible aún en window');
                }
            } catch (e) {
                console.warn('Error validando conexión Supabase:', e);
            }
        });
    </script>

       <!-- Carga en modo edición o duplicado -->
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const editId = params.get('id');
        const duplicateId = params.get('duplicate');
        const targetId = duplicateId || editId;
        if (!targetId) return;

        try {
          // Asegurar Supabase inicializado
          if (window.supabaseClient?.init) {
            await window.supabaseClient.init();
          }

          // Asegurar que el wizard tenga cliente supabase listo
          if (window.bytWizard?._ensureSupabase) {
            await window.bytWizard._ensureSupabase(5000);
          }

          // Cargar la cotización existente en el wizard
          if (window.bytWizard?.loadCotizacionSupabase) {
            const res = await window.bytWizard.loadCotizacionSupabase(targetId);
            if (!res?.ok) throw new Error(res?.error || 'No se pudo cargar');

            // Si es duplicado, limpiar ID/numero y renombrar proyecto
            if (duplicateId) {
              const d = window.bytWizard.datos || {};
              d._id = null;
              d.numero = 'COT-' + Date.now();
              if (d.cliente) {
                const base = d.cliente.nombre_proyecto || d.cliente.nombre || 'Proyecto';
                d.cliente.nombre_proyecto = `${base} (Copia)`;
              }
              // Re-render paso 1 y barra
              window.bytWizard.mostrarPaso(1);
              window.bytWizard.actualizarBarraSuperior?.();
            }
          } else {
            console.warn('loadCotizacionSupabase no disponible en bytWizard');
          }
        } catch (e) {
          console.error('Error cargando cotización (ed/dup)', e);
          alert('No se pudo cargar la cotización. Intenta de nuevo.');
        }
      });
    </script>







    <script>
document.addEventListener('DOMContentLoaded', () => {
  const steps = [
    '1. Datos del Cliente', '2. Quincallería', '3. Tableros', '4. Tapacantos',
    '5. Tableros de Madera', '6. LED y Electricidad', '7. Otras compras',
    '8. Valores Traspasados', '9. Factor General', '10. Resumen'
  ];
  const nav = document.getElementById('step-nav');
  if (!nav) return;

  nav.innerHTML = steps.map((t, i) =>
    `<button class="step-chip" data-step="${i+1}">${t}</button>`).join('');

  nav.addEventListener('click', (e) => {
    const btn = e.target.closest('.step-chip');
    if (!btn) return;
    const step = Number(btn.dataset.step || 1);
    if (window.bytWizard?.mostrarPaso) window.bytWizard.mostrarPaso(step);
  });

  function updateStepNav(step) {
    nav.querySelectorAll('.step-chip').forEach(chip => {
      chip.classList.toggle('active', Number(chip.dataset.step) === Number(step));
    });
  }

  // Parchear mostrarPaso para actualizar el menú
  const hook = setInterval(() => {
    if (window.bytWizard?.mostrarPaso && !window.bytWizard.__patchedNav) {
      const orig = window.bytWizard.mostrarPaso.bind(window.bytWizard);
      window.bytWizard.mostrarPaso = function(n) {
        const r = orig(n);
        updateStepNav(n);
        return r;
      };
      window.bytWizard.__patchedNav = true;
      updateStepNav(window.bytWizard.pasoActual || 1);
    }
  }, 200);
  setTimeout(() => clearInterval(hook), 4000);
});
</script>



    


    
</body>
</html>




