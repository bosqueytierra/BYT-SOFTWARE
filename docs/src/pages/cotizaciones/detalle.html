<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Detalle Cotización - BYT SOFTWARE</title>
    <link rel="stylesheet" href="../../styles/global.css" />
    <style>
        :root {
            --bg: #f6f7f8;
            --card: #ffffff;
            --border: #e4e7eb;
            --text: #2d2d2d;
            --muted: #6c7a86;
            --primary: #2e5e4e;
            --primary-soft: #3f705d;
        }
        body { background: var(--bg); }
        .detalle-section { margin-bottom: 30px; }
        .detalle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .detalle-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid var(--primary);
        }
        .detalle-label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .detalle-value {
            font-size: 16px;
            color: var(--text);
            font-weight: 500;
        }
        .table-container { overflow-x:auto; }
        .table { width:100%; border-collapse: collapse; margin-top:10px; }
        .table th, .table td { padding:10px; border:1px solid #e6efe9; }
        .table th { background:#f5f7f6; color:#2e6b57; font-weight:700; text-align:left; }
        .no-data { color:#666; text-align:center; padding:18px; }

        /* Archivos */
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 14px;
        }
        .file-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .file-preview {
            background: #f4f6f7;
            display: grid;
            place-items: center;
            min-height: 180px;
        }
        .file-preview img {
            max-width: 100%;
            max-height: 320px;
            object-fit: contain;
            display: block;
        }
        .file-body {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .file-name { font-weight: 700; color: var(--text); margin: 0; }
        .file-meta { color: var(--muted); font-size: 12px; }
        .file-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 6px;
        }
        .btn {
            border: 1px solid var(--border);
            background: #fff;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .btn-secondary { color: var(--primary); border-color: rgba(46,94,78,0.25); background: #fff; }
        .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
        .btn-ghost { background: #f0f3f5; color: var(--text); }
        .btn-icon { width: 16px; height: 16px; }

        /* Visor (lightbox) */
        .viewer-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .viewer-overlay.active { display: flex; }
      .viewer-inner {
    position: relative;
    background: #0f1114;
    max-width: 96vw;
    max-height: 92vh;
    width: 96vw;
    height: 92vh;
    border-radius: 14px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
        .viewer-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            color: #fff;
            font-weight: 700;
            background: rgba(255,255,255,0.06);
        }
        .viewer-counter { font-size: 14px; color: #cfd4da; }
        .viewer-close {
            background: transparent; border: none; color: #fff; font-size: 20px; cursor: pointer;
        }
       .viewer-body {
    flex: 1;
    display: grid;
    place-items: center;
    background: #0f1114;
    padding: 16px;
}
        .viewer-body img,
.viewer-body iframe {
    max-width: 90vw;
    max-height: 80vh;
    object-fit: contain;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 12px 28px rgba(0,0,0,0.3);
}
        .viewer-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            width: 100%;
            justify-content: space-between;
            pointer-events: none;
        }
        .viewer-btn {
            pointer-events: all;
            background: rgba(0,0,0,0.45);
            color: #fff;
            border: none;
            border-radius: 999px;
            width: 44px; height: 44px;
            display: grid; place-items: center;
            cursor: pointer;
            margin: 0 10px;
            font-size: 20px;
        }

        @media print {
            .btn-back, .no-print { display: none !important; }
            body { background: white !important; }
            .card { box-shadow: none !important; border: 1px solid #ddd; }
        }
    </style>
    <!-- pdf.js para previsualizar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      if (window['pdfjsLib']) {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }
    </script>
</head>
<body>
    <a href="consultar.html" class="btn-back no-print">← Volver</a>

    <div class="container">
        <header class="header no-print">
            <div class="header-content">
                <div class="logo-section">
                    <img src="../../assets/logo_byt.png" alt="Logo BYT" class="logo" />
                    <div>
                        <h1 class="header-title">Detalle de Cotización</h1>
                        <p class="header-subtitle">Información Completa del Proyecto</p>
                    </div>
                </div>
                <div>
                    <button class="btn btn-secondary" onclick="window.print()">
                        Imprimir
                    </button>
                    <button class="btn btn-ghost" onclick="exportarPDF()">
                        Exportar PDF
                    </button>
                </div>
            </div>
        </header>

        <div id="loading-state" class="card text-center">
            <div class="loading-spinner" style="margin: 20px auto;"></div>
            <p>Cargando cotización...</p>
        </div>

        <div id="detalle-content" style="display: none;">
            <div class="card detalle-section">
                <h3 class="card-title">Información del Proyecto</h3>
                <div class="detalle-grid" id="info-proyecto"></div>
            </div>

            <div class="card detalle-section">
                <h3 class="card-title">Resumen Financiero</h3>
                <div class="detalle-grid" id="resumen-financiero"></div>
            </div>

            <div class="card detalle-section">
                <h3 class="card-title">Materiales</h3>
                <div id="materiales-detalle"></div>
            </div>

            <div class="card detalle-section">
                <h3 class="card-title">Valores Traspasados</h3>
                <div id="valores-detalle"></div>
            </div>

            <div class="card detalle-section">
                <h3 class="card-title">Archivos</h3>
                <div id="archivos-detalle"></div>
            </div>

            <div class="card detalle-section" style="text-align: center; margin-top: 40px;">
                <h4 style="color: var(--primary); margin-bottom: 10px;">Bosque y Tierra</h4>
                <p style="color: #666; margin: 5px 0;">Diseño y Fabricación de Muebles Personalizados</p>
                <p style="color: #666; margin: 5px 0;">Fecha de cotización: <span id="fecha-cotizacion"></span></p>
                <p style="color: #666; margin: 5px 0; font-size: 12px;">© 2025 BYT SOFTWARE - Sistema Interno de Gestión</p>
            </div>
        </div>

        <div id="error-state" class="card text-center" style="display: none;">
            <div style="font-size: 64px; color: #f44336; margin: 20px 0;">❌</div>
            <h3 style="color: #f44336;">Error al cargar cotización</h3>
            <p style="color: #999;" id="error-message">No se pudo cargar la información de la cotización.</p>
            <button class="btn" onclick="cargarCotizacion()">Reintentar</button>
        </div>
    </div>

    <!-- Visor -->
    <div id="file-viewer" class="viewer-overlay">
      <div class="viewer-inner">
        <div class="viewer-top">
          <div class="viewer-counter" id="viewer-counter">1 / 1</div>
          <button class="viewer-close" onclick="closeViewer()">×</button>
        </div>
        <div class="viewer-body" id="viewer-body"></div>
        <div class="viewer-nav">
          <button class="viewer-btn" onclick="prevViewer()">‹</button>
          <button class="viewer-btn" onclick="nextViewer()">›</button>
        </div>
      </div>
    </div>

    <script src="../../lib/supabaseConfig.js"></script>
    <script type="module" src="../../js/supabaseBrowserClient.js"></script>
    <script src="../../js/globalSupabase.js" defer></script>
    <script src="../../js/categorias.js" defer></script>

    <script>
        (function () {
            let cotizacionActual = null;
            let cotizacionId = null;
            const BUCKET = 'cotizaciones';

            // Visor
            let viewerItems = [];
            let viewerIndex = 0;

            if (!localStorage.getItem('byt_logged_in')) {
                window.location.href = '../login/login.html';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            cotizacionId = urlParams.get('id');

            async function start() {
                if (!cotizacionId) {
                    mostrarError('ID de cotización no proporcionado');
                    return;
                }
                try {
                    if (window.supabaseClient && typeof window.supabaseClient.init === 'function') {
                        await window.supabaseClient.init();
                    } else {
                        await new Promise(res => {
                            let resolved = false;
                            const onReady = () => { if (!resolved) { resolved = true; window.removeEventListener('supabase:ready', onReady); res(); } };
                            window.addEventListener('supabase:ready', onReady);
                            setTimeout(() => { if (!resolved) { resolved = true; window.removeEventListener('supabase:ready', onReady); res(); } }, 3000);
                        });
                    }
                } catch (e) {
                    console.warn('Error inicializando supabaseClient desde detalle:', e);
                }
                cargarCotizacion();
            }

            async function cargarCotizacion() {
                mostrarEstado('loading');
                try {
                    if (!window.supabaseClient || typeof window.supabaseClient.obtenerCotizacionPorId !== 'function') {
                        throw new Error('supabaseClient no disponible');
                    }
                    const resultado = await window.supabaseClient.obtenerCotizacionPorId(cotizacionId);
                    if (resultado.success && resultado.data) {
                        cotizacionActual = resultado.data;
                        mostrarDetalle();
                        await cargarArchivos();
                    } else {
                        throw new Error(resultado.error || 'Cotización no encontrada');
                    }
                } catch (error) {
                    console.error('Error al cargar cotización:', error);
                    mostrarError('Error al cargar cotización: ' + (error.message || String(error)));
                }
            }

            function mostrarEstado(estado) {
                const loading = document.getElementById('loading-state');
                const content = document.getElementById('detalle-content');
                const error = document.getElementById('error-state');
                loading.style.display = estado === 'loading' ? 'block' : 'none';
                content.style.display = estado === 'content' ? 'block' : 'none';
                error.style.display = estado === 'error' ? 'block' : 'none';
            }

            function mostrarError(mensaje) {
                mostrarEstado('error');
                const msgEl = document.getElementById('error-message');
                msgEl.textContent = mensaje;
            }

            function mostrarDetalle() {
                mostrarEstado('content');
                mostrarInfoProyecto();
                mostrarResumenFinanciero();
                mostrarMateriales();
                mostrarValoresTraspasados();
                const fecha = new Date(cotizacionActual.created_at || Date.now()).toLocaleDateString('es-CL', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                document.getElementById('fecha-cotizacion').textContent = fecha;
            }

            function mostrarInfoProyecto() {
                const container = document.getElementById('info-proyecto');
                const proyecto = cotizacionActual.nombre_proyecto || cotizacionActual.data?.cliente?.nombre_proyecto || '';
                const cliente = cotizacionActual.cliente || cotizacionActual.data?.cliente?.nombre || '';
                const direccion = cotizacionActual.direccion || cotizacionActual.data?.cliente?.direccion || '';
                const encargado = cotizacionActual.encargado || cotizacionActual.data?.cliente?.encargado || '';
                const notas = cotizacionActual.notas || cotizacionActual.data?.cliente?.notas || '';

                const items = [
                    { label: 'Nombre del Proyecto', value: proyecto || 'N/A' },
                    { label: 'Cliente', value: cliente || 'N/A' },
                    { label: 'Dirección', value: direccion || 'N/A' },
                    { label: 'Encargado', value: encargado || 'N/A' },
                    { label: 'ID Cotización', value: `#${cotizacionActual.id || (cotizacionActual._id || '')}` },
                    { label: 'Fecha de Creación', value: new Date(cotizacionActual.created_at || cotizacionActual._created_at || Date.now()).toLocaleDateString('es-CL') }
                ];
                
                let html = '';
                items.forEach(item => {
                    html += `
                        <div class="detalle-item">
                            <div class="detalle-label">${item.label}</div>
                            <div class="detalle-value">${item.value}</div>
                        </div>
                    `;
                });
                
                if (notas) {
                    html += `
                        <div class="detalle-item" style="grid-column: 1 / -1;">
                            <div class="detalle-label">Notas del Proyecto</div>
                            <div class="detalle-value">${escapeHtml(notas)}</div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            }

            function mostrarResumenFinanciero() {
                const container = document.getElementById('resumen-financiero');
                const total_materiales = cotizacionActual.total_materiales ?? cotizacionActual.data?.subtotal ?? cotizacionActual.subtotal ?? 0;
                const factor = cotizacionActual.factor ?? cotizacionActual.data?.factor ?? cotizacionActual.data?.factorGeneral ?? 1.3;
                const total_neto = cotizacionActual.total_neto ?? cotizacionActual.data?.neto ?? cotizacionActual.total ?? 0;
                const iva = cotizacionActual.iva ?? cotizacionActual.data?.iva ?? 0;
                const total_proyecto = cotizacionActual.total_proyecto ?? cotizacionActual.data?.total ?? 0;
                const ganancia = cotizacionActual.ganancia ?? cotizacionActual.data?.ganancia ?? 0;

                const items = [
                    { label: 'Total Materiales', value: formatPrecio(total_materiales) },
                    { label: 'Factor Aplicado', value: `${factor}x` },
                    { label: 'Subtotal con Factor', value: formatPrecio(total_neto) },
                    { label: 'IVA (19%)', value: formatPrecio(iva) },
                    { label: 'Total del Proyecto', value: formatPrecio(total_proyecto), destacado: true },
                    { label: 'Ganancia Estimada', value: formatPrecio(ganancia) }
                ];
                
                let html = '';
                items.forEach(item => {
                    const estilo = item.destacado ? 'background: var(--primary); color: white; font-weight: 600;' : '';
                    html += `
                        <div class="detalle-item" style="${estilo}">
                            <div class="detalle-label" style="${item.destacado ? 'color: rgba(255,255,255,0.85);' : ''}">${item.label}</div>
                            <div class="detalle-value" style="${item.destacado ? 'color: white; font-size: 18px;' : ''}">${item.value}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }

            function mostrarMateriales() {
                const container = document.getElementById('materiales-detalle');
                let html = '';
                const datosMateriales = cotizacionActual.data?.materiales || {};
                const camposPosibles = ['quincalleria','tableros','tapacantos','corte','madera','led','otras_compras','otras_compras'];
                let foundAny = false;
                const categoriasMeta = window.categorias && window.categorias.materiales ? window.categorias.materiales : null;

                if (datosMateriales && Object.keys(datosMateriales).length > 0) {
                    Object.keys(datosMateriales).forEach(catKey => {
                        const materiales = datosMateriales[catKey] || {};
                        const nombreCat = (categoriasMeta && categoriasMeta[catKey] && categoriasMeta[catKey].nombre) ? categoriasMeta[catKey].nombre : catKey;
                        const filas = [];
                        let subtotal = 0;
                        Object.values(materiales).forEach(mat => {
                            const cantidad = Number(mat.cantidad || 0);
                            const precio = Number(mat.precio || mat.valor || 0);
                            if (cantidad > 0 || precio > 0) {
                                const total = cantidad * precio;
                                subtotal += total;
                                filas.push(`<tr>
                                    <td>${escapeHtml(mat.nombre || mat.descripcion || 'Ítem')}</td>
                                    <td style="text-align:center;">${cantidad}</td>
                                    <td style="text-align:right;">${formatPrecio(precio)}</td>
                                    <td style="text-align:right;font-weight:600;">${formatPrecio(total)}</td>
                                </tr>`);
                            }
                        });
                        if (filas.length > 0) {
                            foundAny = true;
                            html += `
                                <div style="margin-bottom:20px;">
                                    <h4 style="color:var(--primary); margin-bottom:12px;">${escapeHtml(nombreCat)}</h4>
                                    <div class="table-container">
                                        <table class="table">
                                            <thead>
                                                <tr><th>Material</th><th style="width:100px;text-align:center;">Cant.</th><th style="width:140px;text-align:right;">V.Unit.</th><th style="width:160px;text-align:right;">Subtotal</th></tr>
                                            </thead>
                                            <tbody>
                                                ${filas.join('')}
                                                <tr style="background: rgba(46,94,78,0.06); font-weight:600;">
                                                    <td colspan="3" style="text-align:right;">Subtotal ${escapeHtml(nombreCat)}:</td>
                                                    <td style="text-align:right; color:var(--primary);">${formatPrecio(subtotal)}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        }
                    });
                } else {
                    camposPosibles.forEach(catKey => {
                        try {
                            const raw = cotizacionActual[catKey];
                            if (!raw) return;
                            const datos = (typeof raw === 'string') ? JSON.parse(raw) : raw;
                            let filas = '';
                            let subtotal = 0;
                            const meta = categoriasMeta && categoriasMeta[catKey] ? categoriasMeta[catKey] : null;
                            if (typeof datos === 'object') {
                                if (meta && Array.isArray(meta.items)) {
                                    meta.items.forEach(itemMeta => {
                                        const cantidad = Number(datos[itemMeta.id] || 0);
                                        if (cantidad > 0) {
                                            const precio = Number(itemMeta.precio || 0);
                                            const total = cantidad * precio;
                                            subtotal += total;
                                            filas += `<tr>
                                                <td>${escapeHtml(itemMeta.nombre)}</td>
                                                <td style="text-align:center;">${cantidad} ${itemMeta.unidad ? itemMeta.unidad : ''}</td>
                                                <td style="text-align:right;">${formatPrecio(precio)}</td>
                                                <td style="text-align:right;font-weight:600;">${formatPrecio(total)}</td>
                                            </tr>`;
                                        }
                                    });
                                } else {
                                    Object.keys(datos).forEach(k => {
                                        const cantidad = Number(datos[k] || 0);
                                        if (cantidad > 0) {
                                            const total = cantidad;
                                            subtotal += total;
                                            filas += `<tr>
                                                <td>${escapeHtml(k)}</td>
                                                <td style="text-align:center;">${cantidad}</td>
                                                <td style="text-align:right;">-</td>
                                                <td style="text-align:right;font-weight:600;">${formatPrecio(total)}</td>
                                            </tr>`;
                                        }
                                    });
                                }
                            }
                            if (filas) {
                                foundAny = true;
                                const titulo = (meta && meta.nombre) ? meta.nombre : catKey;
                                html += `
                                    <div style="margin-bottom:20px;">
                                        <h4 style="color:var(--primary); margin-bottom:12px;">${escapeHtml(titulo)}</h4>
                                        <div class="table-container">
                                            <table class="table">
                                                <thead><tr><th>Material</th><th style="width:100px;text-align:center;">Cant.</th><th style="width:140px;text-align:right;">V.Unit.</th><th style="width:160px;text-align:right;">Subtotal</th></tr></thead>
                                                <tbody>
                                                    ${filas}
                                                    <tr style="background: rgba(46,94,78,0.06); font-weight:600;">
                                                        <td colspan="3" style="text-align:right;">Subtotal ${escapeHtml(titulo)}:</td>
                                                        <td style="text-align:right; color:var(--primary);">${formatPrecio(subtotal)}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                `;
                            }
                        } catch (e) { }
                    });
                }

                if (!foundAny) {
                    html = '<p class="no-data">No se registraron materiales para este proyecto.</p>';
                }
                container.innerHTML = html;
            }

            function mostrarValoresTraspasados() {
                const container = document.getElementById('valores-detalle');
                const trasp = getTraspasados(cotizacionActual);
                let html = '';
                const secciones = Object.keys(trasp).filter(k => trasp[k] && trasp[k].materiales && Object.keys(trasp[k].materiales).length);
                if (!secciones.length) {
                    container.innerHTML = '<p class="no-data">No se registraron valores traspasados para este proyecto.</p>';
                    return;
                }

                secciones.forEach(sec => {
                    const cat = trasp[sec] || {};
                    const factor = cat.factor || 0;
                    const items = cat.materiales || {};
                    let filas = '';
                    let totalBase = 0;

                    Object.keys(items).forEach(k => {
                        const it = items[k] || {};
                        const sub = (Number(it.cantidad || 0) * Number(it.precio || 0)) || 0;
                        totalBase += sub;
                        filas += `
                            <tr>
                                <td>${escapeHtml(it.nombre || k)}</td>
                                <td>${escapeHtml(it.descripcion || '')}</td>
                                <td>${escapeHtml(it.lugar || '')}</td>
                                <td>${Number(it.cantidad || 0)}</td>
                                <td>$${Number(it.precio || 0).toLocaleString()}</td>
                                <td style="font-weight:600;">$${sub.toLocaleString()}</td>
                            </tr>
                        `;
                    });

                    const totalFactor = totalBase * factor;
                    html += `
                        <div class="detalle-section">
                            <h4 style="margin: 0 0 10px 0; color: var(--primary); text-transform: uppercase;">
                                ${escapeHtml(cat.nombre || sec)} ${factor ? `(factor ${Number(factor).toFixed(2)})` : ''}
                            </h4>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Servicio</th>
                                            <th>Descripción</th>
                                            <th>Lugar</th>
                                            <th>Cant.</th>
                                            <th>Valor Unit.</th>
                                            <th>Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filas || '<tr><td colspan="6" class="no-data">Sin datos</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                            <div style="margin-top:10px; font-weight:600;">
                                Total base: $${totalBase.toLocaleString()} &nbsp; | &nbsp;
                                Factor (${Number(factor).toFixed(2)}): $${totalFactor.toLocaleString()} &nbsp; | &nbsp;
                                Total con factor: $${(totalBase + totalFactor).toLocaleString()}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            function getTraspasados(c) {
                if (c?.data?.valoresTraspasados) return c.data.valoresTraspasados;
                if (c?.valoresTraspasados) return c.valoresTraspasados;
                return buildLegacyTrasp(c);
            }
            function buildLegacyTrasp(c) {
                const hasLegacy = ['fierro','cuarzo','ventanas','transporte','almuerzo'].some(k => c && c[k]);
                const extras = safeJSON(c?.extras);
                if (!hasLegacy && !extras) return {};
                const res = {};
                ['fierro','cuarzo','ventanas','transporte','almuerzo'].forEach(k => {
                    if (c && c[k]) {
                        res[k] = {
                            nombre: k.toUpperCase(),
                            factor: 0,
                            materiales: {
                                [k]: { nombre: k.toUpperCase(), cantidad: 1, precio: Number(c[k]) || 0, descripcion: '' }
                            }
                        };
                    }
                });
                if (extras && typeof extras === 'object') {
                    res.extras = { nombre: 'EXTRAS', factor: 0, materiales: {} };
                    Object.keys(extras).forEach(k => {
                        const v = extras[k];
                        res.extras.materiales[k] = {
                            nombre: v?.nombre || k,
                            cantidad: v?.cantidad || 1,
                            precio: v?.precio || Number(v) || 0,
                            descripcion: v?.descripcion || ''
                        };
                    });
                }
                return res;
            }
            function safeJSON(v) {
                if (!v) return null;
                if (typeof v === 'string') { try { return JSON.parse(v); } catch (_) { return null; } }
                return v;
            }

            // ========= ARCHIVOS =========
            async function cargarArchivos() {
                const cont = document.getElementById('archivos-detalle');
                cont.innerHTML = '<div class="no-data">Cargando archivos...</div>';
                if (!window.supabase) {
                    cont.innerHTML = '<div class="no-data">No se pudo inicializar Supabase para cargar archivos.</div>';
                    return;
                }
                try {
                    const { data, error } = await window.supabase
                        .from('cotizacion_files')
                        .select('*')
                        .eq('cotizacion_id', cotizacionId)
                        .order('created_at', { ascending: false });
                    if (error) throw error;
                    const files = data || [];
                    if (!files.length) {
                        cont.innerHTML = '<div class="no-data">No hay archivos para esta cotización.</div>';
                        return;
                    }
                    const items = await Promise.all(files.map(async f => {
                        const { data: signed } = await window.supabase
                            .storage.from(BUCKET)
                            .createSignedUrl(f.path, 3600);
                        const url = signed?.signedUrl || null;
                        return { ...f, signedUrl: url };
                    }));
                    viewerItems = items;
                    renderArchivos(items);
                } catch (e) {
                    console.error('Archivos error:', e);
                    cont.innerHTML = '<div class="no-data">No se pudieron cargar los archivos.</div>';
                }
            }

            function renderArchivos(items) {
                const cont = document.getElementById('archivos-detalle');
                const html = items.map((item, idx) => renderFileCard(item, idx)).join('');
                cont.innerHTML = `<div class="files-grid">${html}</div>`;
                items.forEach(item => {
                    if (isPdf(item.content_type || item.filename)) {
                        renderPdfPreview(item);
                    }
                });
            }

            function renderFileCard(file, idx) {
                const isImg = isImage(file.content_type || file.filename);
                const isPdfFile = isPdf(file.content_type || file.filename);
                const name = file.filename || file.path || 'archivo';
                const sizeMB = file.size ? (file.size / 1024 / 1024).toFixed(2) + ' MB' : '';
                const preview = isImg
                    ? `<img src="${file.signedUrl || ''}" alt="${escapeHtml(name)}">`
                    : (isPdfFile
                        ? `<canvas id="pdf-canvas-${file.id}" style="max-width:100%;"></canvas>`
                        : `<div style="padding:24px; color:var(--muted);">Sin preview</div>`);
                return `
                  <div class="file-card">
                    <div class="file-preview">${preview}</div>
                    <div class="file-body">
                      <p class="file-name">${escapeHtml(name)}</p>
                      <div class="file-meta">${escapeHtml(file.content_type || '')} ${sizeMB ? '· ' + sizeMB : ''}</div>
                      <div class="file-actions">
                        <button class="btn btn-secondary" onclick="openViewer(${idx})">Ver</button>
                        <a class="btn btn-secondary" href="${file.signedUrl || '#'}" target="_blank" rel="noopener" download>
                          Descargar
                        </a>
                        <button class="btn btn-primary" onclick="imprimirArchivo('${file.signedUrl || ''}')">Imprimir</button>
                      </div>
                    </div>
                  </div>
                `;
            }

            function isImage(ct) {
                const c = (ct || '').toLowerCase();
                return /^image\//i.test(c) || /\.(png|jpe?g|gif|webp|bmp)$/i.test(c);
            }
            function isPdf(ct) {
                const c = (ct || '').toLowerCase();
                return /pdf$/i.test(c) || /\.pdf$/i.test(c);
            }

            async function renderPdfPreview(file) {
                if (!file.signedUrl || !window['pdfjsLib']) return;
                const canvas = document.getElementById(`pdf-canvas-${file.id}`);
                if (!canvas) return;
                try {
                    const loadingTask = pdfjsLib.getDocument(file.signedUrl);
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 1.0 });
                    const scale = Math.min(1.4, 400 / viewport.width);
                    const scaled = page.getViewport({ scale });
                    const context = canvas.getContext('2d');
                    canvas.width = scaled.width;
                    canvas.height = scaled.height;
                    await page.render({ canvasContext: context, viewport: scaled }).promise;
                } catch (e) {
                    console.warn('No se pudo renderizar PDF', e);
                }
            }

            // Visor (lightbox)
            window.openViewer = function(idx) {
                if (!viewerItems.length) return;
                viewerIndex = Math.max(0, Math.min(viewerItems.length - 1, idx));
                renderViewer();
                const overlay = document.getElementById('file-viewer');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            };
            window.closeViewer = function() {
                const overlay = document.getElementById('file-viewer');
                overlay.classList.remove('active');
                document.getElementById('viewer-body').innerHTML = '';
                document.body.style.overflow = '';
            };
            window.nextViewer = function() {
                if (!viewerItems.length) return;
                viewerIndex = (viewerIndex + 1) % viewerItems.length;
                renderViewer();
            };
            window.prevViewer = function() {
                if (!viewerItems.length) return;
                viewerIndex = (viewerIndex - 1 + viewerItems.length) % viewerItems.length;
                renderViewer();
            };
            function renderViewer() {
                const body = document.getElementById('viewer-body');
                const counter = document.getElementById('viewer-counter');
                const item = viewerItems[viewerIndex];
                const name = item.filename || item.path || 'archivo';
                counter.textContent = `${viewerIndex + 1} / ${viewerItems.length}`;
                if (isImage(item.content_type || name)) {
                    body.innerHTML = `<img src="${item.signedUrl}" alt="${escapeHtml(name)}">`;
                } else if (isPdf(item.content_type || name)) {
                    body.innerHTML = `<iframe src="${item.signedUrl}" style="border:0; width:100%; height:100%; background:#fff;"></iframe>`;
                } else {
                    body.innerHTML = `<div style="color:#fff; padding:20px;">No hay vista previa para este tipo de archivo.</div>`;
                }
            }
            document.addEventListener('keydown', (e) => {
                const overlay = document.getElementById('file-viewer');
                if (!overlay.classList.contains('active')) return;
                if (e.key === 'Escape') closeViewer();
                if (e.key === 'ArrowRight') nextViewer();
                if (e.key === 'ArrowLeft') prevViewer();
            });
            document.getElementById('file-viewer').addEventListener('click', (e) => {
                if (e.target.id === 'file-viewer') closeViewer();
            });

            function formatPrecio(n) {
                if (window.categorias && typeof window.categorias.formatearPrecio === 'function') {
                    try { return window.categorias.formatearPrecio(n); } catch (e) {}
                }
                const num = Number(n || 0);
                return '$' + num.toLocaleString('es-CL');
            }

            function escapeHtml(str) {
                if (str === undefined || str === null) return '';
                return String(str).replace(/[&<>"']/g, (s) => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[s]);
            }

            function exportarPDF() {
                if (window.utils && typeof window.utils.mostrarNotificacion === 'function') {
                    window.utils.mostrarNotificacion('Función de exportación PDF en desarrollo', 'info');
                } else {
                    alert('Función de exportación PDF en desarrollo');
                }
            }

            window.imprimirArchivo = function(url) {
                if (!url) return;
                const w = window.open(url, '_blank');
                if (!w) return;
                const checkLoaded = setInterval(() => {
                    if (w.document?.readyState === 'complete') {
                        clearInterval(checkLoaded);
                        w.focus();
                        w.print();
                    }
                }, 300);
            };

            window.cargarCotizacion = cargarCotizacion;
            window.exportarPDF = exportarPDF;
            window.mostrarError = mostrarError;

            document.addEventListener('DOMContentLoaded', function() {
                start();
            });
        })();
    </script>
</body>
</html>
