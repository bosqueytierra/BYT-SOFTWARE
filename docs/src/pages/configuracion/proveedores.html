<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Configuración - Proveedores</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px}
    th{background:#f5f5f5;text-align:left}
    input[type=text]{width:100%;box-sizing:border-box;padding:6px}
    button{padding:6px 10px;margin-right:6px}
    .actions{display:flex;gap:6px}
  </style>
</head>
<body>
  <h2>Configuración — Proveedores</h2>
  <div>
    <button id="btnNew">+ Nuevo Proveedor</button>
    <button id="btnReload">Recargar</button>
  </div>
  <table id="providersTable" aria-label="Proveedores">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Website</th>
        <th>Teléfono</th>
        <th>Activo</th>
        <th>Creado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { listProviders, createProvider, updateProvider, deleteProvider } from '../../lib/providersApi.js';

    const tbody = document.querySelector('#providersTable tbody');
    const btnNew = document.getElementById('btnNew');
    const btnReload = document.getElementById('btnReload');

    async function loadAdminProviders() {
      tbody.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
      const { data, error } = await listProviders({ onlyActive: false });
      if (error) {
        tbody.innerHTML = `<tr><td colspan="6">Error: ${error.message || JSON.stringify(error)}</td></tr>`;
        return;
      }
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">No hay proveedores</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      data.forEach(p => {
        const tr = document.createElement('tr');
        tr.dataset.id = p.id || '';
        tr.innerHTML = `
          <td><input class="prov-name" data-id="${p.id||''}" value="${(p.name||'')}" /></td>
          <td><input class="prov-web"  data-id="${p.id||''}" value="${(p.website||'')}" /></td>
          <td><input class="prov-phone" data-id="${p.id||''}" value="${(p.phone||'')}" /></td>
          <td style="text-align:center;">
            <input type="checkbox" class="prov-active" data-id="${p.id||''}" ${p.active ? 'checked' : ''} />
          </td>
          <td>${p.created_at ? new Date(p.created_at).toLocaleString() : '-'}</td>
          <td class="actions">
            <button class="saveProv" data-id="${p.id||''}">Guardar</button>
            <button class="toggleProv" data-id="${p.id||''}">${p.active ? 'Desactivar' : 'Activar'}</button>
            <button class="hardDeleteProv" data-id="${p.id||''}">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // attach events
      document.querySelectorAll('.saveProv').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = btn.dataset.id;
          const row = btn.closest('tr');
          const payload = {
            name: row.querySelector('.prov-name').value.trim(),
            website: row.querySelector('.prov-web').value.trim(),
            phone: row.querySelector('.prov-phone').value.trim(),
            active: !!row.querySelector('.prov-active').checked
          };
          const res = await updateProvider(id, payload);
          if (res.error) return alert('Error guardando: ' + (res.error.message||JSON.stringify(res.error)));
          alert('Guardado');
          await reloadAll();
        });
      });

      document.querySelectorAll('.toggleProv').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = btn.dataset.id;
          const row = btn.closest('tr');
          const current = !!row.querySelector('.prov-active').checked;
          const res = await updateProvider(id, { active: !current });
          if (res.error) return alert('Error: ' + (res.error.message||JSON.stringify(res.error)));
          await reloadAll();
        });
      });

      document.querySelectorAll('.hardDeleteProv').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          if (!confirm('Eliminar proveedor permanentemente?')) return;
          const id = btn.dataset.id;
          const res = await deleteProvider(id, { soft: false });
          if (res.error) return alert('Error al eliminar: ' + (res.error.message||JSON.stringify(res.error)));
          await reloadAll();
        });
      });
    }

    async function reloadAll() {
      await loadAdminProviders();
      // avisar al wizard (si está abierto en otra pestaña o en la misma)
      try { if (window.wizard && typeof window.wizard.loadProviders === 'function') await window.wizard.loadProviders(); } catch(e){ console.warn(e); }
    }

    btnNew.addEventListener('click', async () => {
      const name = prompt('Nombre del nuevo proveedor:');
      if (!name) return;
      const res = await createProvider({ name });
      if (res.error) return alert('Error creando: ' + (res.error.message||JSON.stringify(res.error)));
      await reloadAll();
    });

    btnReload.addEventListener('click', reloadAll);

    // inicial
    loadAdminProviders();
  </script>
</body>
</html>
