<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compras - BYT SOFTWARE</title>
  <link rel="stylesheet" href="../../styles/global.css">
  <style>
    :root {
      --bg: #f6f7f8;
      --card: #ffffff;
      --border: #e4e7eb;
      --text: #2d2d2d;
      --muted: #6c7a86;
      --primary: #2e5e4e;
      --primary-soft: #3f705d;
      --shadow: 0 6px 16px rgba(0,0,0,0.06);
    }
    body {
      margin: 0;
      font-family: "Inter","SF Pro Display","Roboto",system-ui,sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .page { max-width: 1280px; margin: 22px auto 48px; padding: 0 16px; }
    .header-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      gap: 14px;
      align-items: center;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .block-list { display: flex; flex-direction: column; gap: 12px; }
    .block-header { display: flex; justify-content: space-between; gap: 12px; align-items: center; }
    .meta { color: var(--muted); font-size: 13px; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      background: #eef2f5;
      color: var(--text);
      border-radius: 10px;
      padding: 4px 10px;
      border: 1px solid var(--border);
      font-size: 13px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td {
      padding: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
      text-align: left;
    }
    th { background: #f7f9fb; }
    .btn {
      border: 1px solid var(--border);
      background: #fff;
      color: #1f2430;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
    .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn-ghost { background: #f0f3f5; color: #1f2430; }
    .empty { text-align: center; color: var(--muted); padding: 24px 12px; border: 1px dashed var(--border); border-radius: 12px; background: #fff; }
  </style>
</head>
<body>
  <div class="page">
    <div class="header-card">
      <div>
        <h1 style="margin:0;">Compras</h1>
        <p class="meta" style="margin:4px 0 0;">Bloques de compras generados al aprobar cotizaciones</p>
      </div>
      <div class="chips">
        <span class="chip" id="statBloques">Bloques: 0</span>
      </div>
    </div>

    <div id="blocksContainer" class="block-list" style="margin-top:14px;"></div>
    <div id="emptyState" class="empty" style="display:none;">No hay bloques de compras aún.</div>
  </div>

  <script src="../../js/menuConfig.js"></script>
  <script src="../../js/layout.js"></script>
  <script src="../../lib/supabaseConfig.js"></script>
  <script type="module" src="../../js/supabaseBrowserClient.js"></script>
  <script src="../../js/globalSupabase.js" defer></script>

  <script>
    const blocksContainer = document.getElementById('blocksContainer');
    const emptyState = document.getElementById('emptyState');
    const statBloques = document.getElementById('statBloques');

    document.addEventListener('DOMContentLoaded', async () => {
      await loadBlocks();
    });

    async function loadBlocks() {
      try {
        if (window.supabaseClient?.init) await window.supabaseClient.init();
        const { data, error } = await window.supabaseClient.listarBloquesCompras();
        if (error) throw error;
        renderBlocks(data || []);
      } catch (e) {
        console.error('Error cargando bloques de compras', e);
        window.utils?.mostrarNotificacion?.('Error cargando compras', 'error');
      }
    }

    function renderBlocks(blocks) {
      statBloques.textContent = `Bloques: ${blocks.length}`;
      if (!blocks.length) {
        emptyState.style.display = 'block';
        blocksContainer.innerHTML = '';
        return;
      }
      emptyState.style.display = 'none';
      blocksContainer.innerHTML = blocks.map(b => blockCard(b)).join('');
      // bind toggles
      document.querySelectorAll('[data-block-toggle]').forEach(btn => {
        btn.onclick = () => toggleLines(btn.dataset.blockId);
      });
    }

    function blockCard(b) {
      const avanceBase = (Number(b.total_comprado || 0) + Number(b.total_por_comprar || 0)) || 0;
      const pct = avanceBase > 0 ? Math.min(100, Math.round((Number(b.total_comprado || 0) / avanceBase) * 100)) : 0;
      return `
        <div class="card">
          <div class="block-header">
            <div>
              <h3 style="margin:0 0 4px;">${escapeHtml(b.proyecto_nombre || 'Proyecto')}</h3>
              <div class="meta">Estado: ${escapeHtml(b.estado || 'en_compra')} · Creado: ${formatDate(b.created_at)}</div>
            </div>
            <button class="btn btn-ghost" data-block-toggle data-block-id="${b.id}">Ver detalle</button>
          </div>
          <div class="chips" style="margin:8px 0;">
            <span class="chip">Total cotizado: ${fmtCLP(b.total_cotizado)}</span>
            <span class="chip">Total cobrado: ${fmtCLP(b.total_cobrado)}</span>
            <span class="chip">Comprado: ${fmtCLP(b.total_comprado)}</span>
            <span class="chip">Por comprar: ${fmtCLP(b.total_por_comprar)}</span>
            <span class="chip">Avance: ${pct}%</span>
          </div>
          <div id="lines-${b.id}" style="display:none; margin-top:8px;">
            <div class="meta" style="margin-bottom:6px;">Líneas de compra</div>
            <div class="lines-table" data-lines-table="${b.id}">Cargando...</div>
          </div>
        </div>
      `;
    }

    async function toggleLines(blockId) {
      const wrap = document.getElementById(`lines-${blockId}`);
      if (!wrap) return;
      const isHidden = wrap.style.display === 'none';
      if (!isHidden) {
        wrap.style.display = 'none';
        return;
      }
      wrap.style.display = 'block';
      const tableEl = wrap.querySelector('[data-lines-table]');
      tableEl.textContent = 'Cargando...';
      try {
        const { data, error } = await window.supabaseClient.listarLineasCompra(blockId);
        if (error) throw error;
        tableEl.innerHTML = renderLinesTable(data || []);
      } catch (e) {
        console.error('Error cargando líneas', e);
        tableEl.textContent = 'Error al cargar líneas';
      }
    }

    function renderLinesTable(lines) {
      if (!lines.length) {
        return '<div class="meta">Sin líneas de compra todavía.</div>';
      }
      const header = `
        <tr>
          <th>Encargado</th>
          <th>Proveedor</th>
          <th>Dirección</th>
          <th>Categoría</th>
          <th>Producto</th>
          <th>Unidad</th>
          <th>Cantidad</th>
          <th>Precio Unit</th>
          <th>Total</th>
          <th>Modo</th>
          <th>Estado pago</th>
          <th>Obs</th>
        </tr>`;
      const rows = lines.map(l => `
        <tr>
          <td>${escapeHtml(l.encargado || '')}</td>
          <td>${escapeHtml(l.proveedor_id || '')}</td>
          <td>${escapeHtml(l.direccion || '')}</td>
          <td>${escapeHtml(l.categoria || '')}</td>
          <td>${escapeHtml(l.producto_id || '')}</td>
          <td>${escapeHtml(l.unidad || '')}</td>
          <td>${Number(l.cantidad || 0)}</td>
          <td>${fmtCLP(l.precio_unit)}</td>
          <td>${fmtCLP(l.total)}</td>
          <td>${escapeHtml(l.modo_compra || '')}</td>
          <td>${escapeHtml(l.estado_pago || '')}</td>
          <td>${escapeHtml(l.observaciones || '')}</td>
        </tr>`).join('');
      return `<table>${header}${rows}</table>`;
    }

    function fmtCLP(n) {
      const num = Number(n || 0);
      return num.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
    }
    function formatDate(d) {
      if (!d) return '-';
      return new Date(d).toLocaleDateString('es-CL');
    }
    function escapeHtml(str) {
      if (str === undefined || str === null) return '';
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
