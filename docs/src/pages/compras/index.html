<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compras - BYT SOFTWARE</title>
  <link rel="stylesheet" href="../../styles/global.css">
  <style>
    :root { --bg:#f6f7f8; --card:#fff; --border:#d4d8dd; --text:#2d2d2d; --muted:#6c7a86; --primary:#2e5e4e; --shadow:0 6px 16px rgba(0,0,0,0.06); }
    html, body { width:100%; min-height:100vh; display:block; }
    body { margin:0; font-family:"Inter","SF Pro Display","Roboto",system-ui,sans-serif; background:var(--bg); color:var(--text); }
    .page { width:100%; max-width:1800px; margin:16px auto 48px; padding:0 16px; display:block; }
    .header-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:var(--shadow); display:flex; justify-content:space-between; gap:14px; align-items:center; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow); width:100%; }
    .block-list { display:flex !important; flex-direction:column; gap:14px; width:100%; }
    .block-header { display:flex; justify-content:space-between; gap:12px; align-items:center; }
    .meta { color:var(--muted); font-size:13px; }
    .chips { display:flex; gap:8px; flex-wrap:wrap; }
    .chip { background:#eef2f5; color:#2d2d2d; border-radius:10px; padding:4px 10px; border:1px solid var(--border); font-size:13px; }
    .btn { border:1px solid var(--border); background:#fff; color:#1f2430; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:600; font-size:13px; display:inline-flex; align-items:center; gap:6px; transition:background .12s ease; height:30px; box-shadow:none; }
    .btn:hover { background:#eef2f5; }
    .btn-primary { background:var(--primary); color:#fff; border-color:var(--primary); }
    .btn-primary:hover { background:#264d40; }
    .btn-ghost { background:#f4f5f6; color:#1f2430; border-color:#d4d8dd; }
    .empty { text-align:center; color:#6c7a86; padding:24px 12px; border:1px dashed var(--border); border-radius:12px; background:#fff; }

    body.overlay-open { overflow:hidden; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 9999; padding: 10px; }
    .overlay.active { display: flex; }
    .overlay-content {
      background: #f8f9fb; border-radius: 10px; box-shadow: 0 18px 60px rgba(0,0,0,0.30);
      width: 98vw; max-width: 2200px; height: 92vh;
      padding: 10px; overflow: hidden; display: flex; flex-direction: column; gap: 8px;
    }
    .overlay-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .overlay-title { font-weight: 700; font-size: 15px; }
    .lines-wrapper { width:100%; overflow:auto; background:#fff; border:1px solid var(--border); border-radius:8px; padding:8px; }
    .table-wrapper { width:100%; overflow:auto; }
    table.lc-table { border-collapse: collapse; width: 100%; min-width: 1400px; }
    table.lc-table thead th { position: sticky; top: 0; background:#e1e5ec; border:1px solid #d7dbe0; padding:6px 6px; font-size:12.5px; font-weight:700; }
    table.lc-table tbody td { border:1px solid #d7dbe0; background:#fff; padding:0; min-height:28px; }
    table.lc-table tbody tr:nth-child(odd) td { background:#f7f8fa; }
    table.lc-table select, table.lc-table input[type=number], table.lc-table input[type=text] { width:100%; height:28px; font-size:13px; padding:2px 6px; box-sizing:border-box; border:none; background:transparent; outline:none; }
    table.lc-table input[type=number] { appearance:none; -moz-appearance:textfield; }
    table.lc-table input::-webkit-outer-spin-button, table.lc-table input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .readonly-cell { background:#f3f4f6; }
    .item-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:18px; }
    .item-card { border:1px solid #d7dbe0; border-radius:12px; background:#fff; padding:10px; display:flex; gap:12px; box-shadow:0 6px 16px rgba(0,0,0,0.05); min-height:180px; }
    .item-thumb { width:120px; height:120px; border:1px solid #e2e5ea; border-radius:10px; background:#f5f7fa; object-fit:cover; flex-shrink:0; }
    .item-body { flex:1; display:flex; flex-direction:column; gap:6px; justify-content:center; }
    .item-body h4 { margin:0; font-size:16px; }
    .item-body .muted { color:#6c7a86; font-size:13px; }
  </style>
</head>
<body>
  <div class="page">
    <div class="header-card">
      <div>
        <h1 style="margin:0;">Compras</h1>
        <p class="meta" style="margin:4px 0 0;">Bloques de compras generados al aprobar cotizaciones</p>
      </div>
      <div class="chips">
        <span class="chip" id="statBloques">Bloques: 0</span>
      </div>
    </div>

    <div id="blocksContainer" class="block-list"></div>
    <div id="emptyState" class="empty" style="display:none;">No hay bloques de compras aún.</div>
  </div>

  <div id="overlay" class="overlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <div class="overlay-title" id="overlayTitle">Ver resumen</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" id="closeOverlay">Cerrar</button>
        </div>
      </div>
      <div class="lines-wrapper">
        <div id="overlayGrid"></div>
      </div>
    </div>
  </div>

  <div id="overlayLC" class="overlay">
    <div class="overlay-content">
      <div class="overlay-header">
        <div class="overlay-title" id="overlayLCTitle">Lista de compras</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" id="addRowBtn">Agregar fila</button>
          <button class="btn" id="closeOverlayLC">Cerrar</button>
        </div>
      </div>
      <div class="lines-wrapper">
        <div id="overlayLCGrid"></div>
      </div>
    </div>
  </div>

  <script src="../../js/menuConfig.js"></script>
  <script src="../../js/layout.js"></script>
  <script src="../../lib/supabaseConfig.js"></script>
  <script type="module" src="../../js/supabaseBrowserClient.js"></script>
  <script type="module" src="../../js/globalSupabase.js"></script>

  <script type="module">
    import * as catApi from '../../lib/cate_material.js';

    let blocksContainer, emptyState, statBloques;
    let overlay, overlayGrid, overlayTitle, closeOverlayBtn;
    let overlayLC, overlayLCGrid, overlayLCTitle, closeOverlayLC, addRowBtn;
    const TABLE = 'purchase_lines';
    const MIN_ROWS = 50; // vuelve a 50 filas estilo "excel"
    let catEncargados = [], catUnidades = [], catModos = [], catEstadosPago = [], proveedores = [], materiales = [];
    let catImagesMap = {};
    let currentRows = [];
    let currentBlockId = null;
    const PLACEHOLDER_IMG = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="120" height="120" fill="%23e5e7eb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%239ca3af" font-size="16">LC</text></svg>';

    function pickLast(sel) { const all = document.querySelectorAll(sel); return all.length ? all[all.length - 1] : null; }
    function ensureEls() {
      blocksContainer = pickLast('#blocksContainer');
      emptyState = pickLast('#emptyState');
      statBloques = pickLast('#statBloques');
      overlay = pickLast('#overlay');
      overlayGrid = pickLast('#overlayGrid');
      overlayTitle = pickLast('#overlayTitle');
      closeOverlayBtn = pickLast('#closeOverlay');
      overlayLC = pickLast('#overlayLC');
      overlayLCGrid = pickLast('#overlayLCGrid');
      overlayLCTitle = pickLast('#overlayLCTitle');
      closeOverlayLC = pickLast('#closeOverlayLC');
      addRowBtn = pickLast('#addRowBtn');
      if (closeOverlayBtn) closeOverlayBtn.onclick = () => { overlay.classList.remove('active'); document.body.classList.remove('overlay-open'); };
      if (closeOverlayLC) closeOverlayLC.onclick = () => { overlayLC.classList.remove('active'); document.body.classList.remove('overlay-open'); };
      if (addRowBtn) addRowBtn.onclick = () => { addEmptyRow(); };
    }

    function getClient() { return window.supabase || window.globalSupabase?.client || window.supabaseClient?.client || null; }
    async function waitForClient(timeoutMs = 4000) {
      const start = performance.now();
      while (performance.now() - start < timeoutMs) {
        const c = getClient();
        if (c) return c;
        await new Promise(r => setTimeout(r, 50));
      }
      throw new Error('Supabase client no inicializado');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      ensureEls();
      try {
        const client = await waitForClient();
        if (!window.supabase && client) window.supabase = client;
        await loadCatalogs();
        await loadBlocks();
      } catch (e) {
        console.error(e);
        window.utils?.mostrarNotificacion?.('Error al iniciar Compras', 'error');
      }
    });

    document.addEventListener('click', (e) => {
      const btnLC = e.target.closest('[data-block-lc]');
      const btnSummary = e.target.closest('[data-block-summary]');
      if (btnLC) { e.preventDefault(); openLC(btnLC.dataset.blockId, btnLC.dataset.blockTitle || ''); }
      if (btnSummary) { e.preventDefault(); openSummary(btnSummary.dataset.blockId, btnSummary.dataset.blockTitle || ''); }
    });

    async function loadCatalogs() {
      const client = await waitForClient();
      const [enc, uni, mod, est] = await Promise.all([
        client.from('purchase_catalog_encargados').select('*').order('nombre'),
        client.from('purchase_catalog_unidades').select('*').order('nombre'),
        client.from('purchase_catalog_modos_compra').select('*').order('nombre'),
        client.from('purchase_catalog_estados_pago').select('*').order('nombre'),
      ]);
      catEncargados = enc.data || [];
      catUnidades   = uni.data || [];
      catModos      = mod.data || [];
      catEstadosPago= est.data || [];

      const { data: provs } = await client.from('providers').select('id,name').order('name');
      proveedores = provs || [];
      const { data: mats } = await client.from('materials').select('id,name,category').order('name');
      materiales = mats || [];
    }

    function filterBlocks(blocks, approvedSet) {
      if (!approvedSet || approvedSet.size === 0) return blocks || [];
      return (blocks || []).filter(b => {
        if (b.deleted_at) return false;
        if (b.activa === false) return false;
        if (!b.proyecto_id) return false;
        return approvedSet.has(b.proyecto_id);
      });
    }

    async function loadBlocks() {
      try {
        const client = await waitForClient();
        const { data: cotAprob, error: errCot } = await client.from('cotizaciones').select('id').eq('estado','aprobada');
        if (errCot) throw errCot;
        const approved = new Set((cotAprob || []).map(c => c.id));

        const { data, error } = await client
          .from('purchase_blocks')
          .select('*')
          .order('created_at', { ascending: false });
        if (error) throw error;

        const filtered = filterBlocks(data || [], approved);
        const toRender = filtered.length ? filtered : (data || []);
        renderBlocks(toRender);
      } catch (e) {
        console.error('Error cargando bloques de compras', e);
        window.utils?.mostrarNotificacion?.('Error cargando compras', 'error');
        renderBlocks([]);
      }
    }

    function renderBlocks(blocks) {
      ensureEls();
      if (!blocksContainer || !statBloques || !emptyState) return;
      statBloques.textContent = `Bloques: ${blocks.length}`;
      if (!blocks.length) {
        emptyState.style.display = 'block';
        blocksContainer.innerHTML = '';
        return;
      }
      emptyState.style.display = 'none';
      blocksContainer.innerHTML = blocks.map(b => blockCard(b)).join('');
    }

    function blockCard(b) {
      const avanceBase = (Number(b.total_comprado || 0) + Number(b.total_por_comprar || 0)) || 0;
      const pct = avanceBase > 0 ? Math.min(100, Math.round((Number(b.total_comprado || 0) / avanceBase) * 100)) : 0;
      const title = escapeHtml(b.proyecto_nombre || 'Proyecto');
      const estadoLabel = escapeHtml(b.cotizacion_estado || b.estado || 'aprobada');
      return `
        <div class="card">
          <div class="block-header">
            <div>
              <h3 style="margin:0 0 4px;">${title}</h3>
              <div class="meta">Estado: ${estadoLabel} · Creado: ${formatDate(b.created_at)} · Coti: ${escapeHtml(b.proyecto_id || '')}</div>
            </div>
            <div style="display:flex; gap:6px;">
              <button class="btn btn-ghost" data-block-lc data-block-id="${b.id}" data-block-title="${title}">Lista de compras</button>
              <button class="btn btn-primary" data-block-summary data-block-id="${b.id}" data-block-title="${title}">Ver resumen</button>
            </div>
          </div>
          <div class="chips" style="margin:8px 0;">
            <span class="chip">Total cotizado: ${fmtCLP(b.total_cotizado)}</span>
            <span class="chip">Total cobrado: ${fmtCLP(b.total_cobrado)}</span>
            <span class="chip">Comprado: ${fmtCLP(b.total_comprado)}</span>
            <span class="chip">Por comprar: ${fmtCLP(b.total_por_comprar)}</span>
            <span class="chip">Avance: ${pct}%</span>
          </div>
        </div>
      `;
    }

    function makeOptions(list, valKey='nombre', labelKey='nombre') {
      return ['<option value="">--</option>', ...list.map(o => `<option value="${escapeHtml(o[valKey])}">${escapeHtml(o[labelKey])}</option>`)].join('');
    }
    function productOptions(category) {
      const list = materiales.filter(m => !category || m.category === category);
      return makeOptions(list, 'id', 'name');
    }
    function rebuildProductOptions(rowIdx) {
      const row = currentRows[rowIdx] || {};
      const sel = overlayLCGrid?.querySelector?.(`select[data-row="${rowIdx}"][data-f="producto_id"]`);
      if (!sel) return;
      sel.innerHTML = productOptions(row.categoria || '');
      if (row.producto_id) {
        sel.value = row.producto_id;
        if (sel.value !== String(row.producto_id)) sel.value = '';
      }
    }
    function setVal(idx, field, value) {
      const el = overlayLCGrid?.querySelector?.(`[data-row="${idx}"][data-f="${field}"]`);
      if (el) el.value = value ?? '';
    }

    function isMeaningful(payload) {
      return (
        (payload.proveedor_id && payload.proveedor_id !== '') ||
        (payload.producto_id && payload.producto_id !== '') ||
        (payload.cantidad && Number(payload.cantidad) > 0) ||
        (payload.precio_unit && Number(payload.precio_unit) > 0) ||
        (payload.observaciones && payload.observaciones.trim() !== '')
      );
    }

    function addEmptyRow() {
      if (!currentBlockId) return;
      currentRows.push({ id: null, block_id: currentBlockId, placeholder: true });
      renderGrid(currentRows);
    }

    function fillPlaceholdersToMin() {
      while (currentRows.length < MIN_ROWS) currentRows.push({ id: null, block_id: currentBlockId, placeholder: true });
    }

    function ensureTrailingPlaceholder() {
      const withData = currentRows.filter(r => !r.placeholder);
      currentRows = [...withData];
      fillPlaceholdersToMin();
      renderGrid(currentRows);
    }

    function renderGrid(rows) {
      if (overlayLCGrid && overlayLCGrid._listenersSet) {
        overlayLCGrid.replaceWith(overlayLCGrid.cloneNode(true));
        overlayLCGrid = document.getElementById('overlayLCGrid');
      }

      const headers = ['Encargado','Proveedor','Dirección','Categoría','Producto','Unidad','Cantidad','Precio Unit','Total','Modo','Estado pago','Obs'];
      const thead = `
        <thead>
          <tr>${headers.map(h => `<th>${escapeHtml(h)}</th>`).join('')}</tr>
        </thead>
      `;

      const bodyRows = rows.map((row, idx) => {
        const idAttr = row.id ? `data-id="${row.id}"` : '';
        return `
          <tr data-row="${idx}" ${idAttr}>
            <td><select data-f="encargado" data-row="${idx}">${makeOptions(catEncargados)}</select></td>
            <td><select data-f="proveedor_id" data-row="${idx}">${makeOptions(proveedores,'id','name')}</select></td>
            <td><input data-f="direccion" data-row="${idx}" type="text" value="${escapeHtml(row.direccion||'')}"></td>
            <td><select data-f="categoria" data-row="${idx}">${makeOptions([...new Set(materiales.map(m=>m.category).filter(Boolean))].map(c=>({nombre:c})))}</select></td>
            <td><select data-f="producto_id" data-row="${idx}"></select></td>
            <td><select data-f="unidad" data-row="${idx}">${makeOptions(catUnidades)}</select></td>
            <td><input data-f="cantidad" data-row="${idx}" type="number" step="0.01" value="${row.cantidad||''}"></td>
            <td><input data-f="precio_unit" data-row="${idx}" type="number" step="0.01" value="${row.precio_unit||''}"></td>
            <td class="readonly-cell"><input data-f="total" data-row="${idx}" type="number" step="0.01" value="${row.total||''}" readonly></td>
            <td><select data-f="modo_compra" data-row="${idx}">${makeOptions(catModos)}</select></td>
            <td><select data-f="estado_pago" data-row="${idx}">${makeOptions(catEstadosPago)}</select></td>
            <td><input data-f="observaciones" data-row="${idx}" type="text" value="${escapeHtml(row.observaciones||'')}"></td>
          </tr>
        `;
      }).join('');

      overlayLCGrid.innerHTML = `
        <div class="table-wrapper">
          <table class="lc-table">
            ${thead}
            <tbody>${bodyRows}</tbody>
          </table>
        </div>
      `;

      rows.forEach((row, idx) => {
        setVal(idx,'encargado',row.encargado);
        setVal(idx,'proveedor_id',row.proveedor_id);
        setVal(idx,'categoria',row.categoria);
        rebuildProductOptions(idx);
        setVal(idx,'producto_id',row.producto_id);
        setVal(idx,'unidad',row.unidad);
        setVal(idx,'modo_compra',row.modo_compra);
        setVal(idx,'estado_pago',row.estado_pago);
      });

      overlayLCGrid.querySelector('table.lc-table')?.addEventListener('change', onCellEdit, false);
      overlayLCGrid.querySelector('table.lc-table')?.addEventListener('input', onCellEdit, false);
      overlayLCGrid._listenersSet = true;
    }

    async function loadLines(blockId) {
      const client = await waitForClient();
      const { data, error } = await client
        .from(TABLE)
        .select('id,block_id,encargado,proveedor_id,direccion,categoria,producto_id,unidad,cantidad,precio_unit,total,modo_compra,estado_pago,observaciones,created_at')
        .eq('block_id', blockId)
        .order('created_at', { ascending: true });
      if (error) {
        console.error('loadLines', error);
        currentRows = [];
      } else {
        currentRows = (data || []).filter(r => isMeaningful(r));
      }
      fillPlaceholdersToMin();
      renderGrid(currentRows);
    }

    async function onCellEdit(e) {
      const field = e.target.getAttribute('data-f');
      const rowIdx = Number(e.target.getAttribute('data-row'));
      if (Number.isNaN(rowIdx) || !field) return;
      const row = currentRows[rowIdx] || {};
      let val = e.target.value;
      if (field === 'cantidad' || field === 'precio_unit') val = Number(val || 0);
      currentRows[rowIdx] = { ...row, [field]: val, block_id: row.block_id || currentBlockId, placeholder: false };
      if (field === 'categoria') {
        currentRows[rowIdx].producto_id = null;
        rebuildProductOptions(rowIdx);
      }
      currentRows[rowIdx].total = Number(currentRows[rowIdx].cantidad || 0) * Number(currentRows[rowIdx].precio_unit || 0);
      const totalInput = overlayLCGrid.querySelector(`input[data-row="${rowIdx}"][data-f="total"]`);
      if (totalInput) totalInput.value = currentRows[rowIdx].total || '';
      await persistRow(rowIdx);
      ensureTrailingPlaceholder();
    }

    function buildPayload(row) {
      return {
        block_id: row.block_id || currentBlockId,
        encargado: row.encargado || null,
        proveedor_id: row.proveedor_id || null,
        direccion: row.direccion || null,
        categoria: row.categoria || null,
        producto_id: row.producto_id || null,
        unidad: row.unidad || null,
        cantidad: row.cantidad || null,
        precio_unit: row.precio_unit || null,
        modo_compra: row.modo_compra || null,
        estado_pago: row.estado_pago || null,
        observaciones: row.observaciones || null
      };
    }

    async function persistRow(idx) {
      const row = currentRows[idx];
      if (!row) return;
      const client = await waitForClient();
      const payload = buildPayload(row);
      const meaningful = isMeaningful(payload);
      if (!row.id && !meaningful) return; // no insertes vacío

      if (row.id && !meaningful) {
        try { await client.from(TABLE).delete().eq('id', row.id); } catch (e) { console.error('delete empty error', e); }
        currentRows.splice(idx, 1);
        fillPlaceholdersToMin();
        renderGrid(currentRows);
        return;
      }

      try {
        if (!row.id) {
          const { data, error } = await client.from(TABLE).insert([payload]).select().single();
          if (error) throw error;
          currentRows[idx] = { ...row, ...data, placeholder: false };
          setVal(idx,'total', data.total);
        } else {
          const { data, error } = await client.from(TABLE).update(payload).eq('id', row.id).select().maybeSingle();
          if (error) throw error;
          if (data) { currentRows[idx] = { ...row, ...data, placeholder: false }; setVal(idx,'total', data.total); }
        }
      } catch (e) { console.error('Persist error', e); }
    }

    async function loadCategoryImages() {
      try {
        const { data } = await catApi.listCategoriesWithImages();
        catImagesMap = (data || []).reduce((a,c)=>{ a[c.name]=c.image_url; return a; },{});
      } catch(e) { console.warn('cat images', e); }
    }
    function pickCategoryImage(cat) { return catImagesMap[cat] || PLACEHOLDER_IMG; }
    async function fetchLines(blockId) {
      const client = await waitForClient();
      const { data, error } = await client
        .from(TABLE)
        .select('id,categoria,producto_id,unidad,cantidad,precio_unit,total,observaciones,created_at')
        .eq('block_id', blockId)
        .neq('categoria', 'Sin categoría')
        .order('created_at', { ascending: true });
      if (error) throw error;
      return data || [];
    }
    function renderSummary(lines) {
      if (!lines.length) {
        overlayGrid.innerHTML = '<div style="padding:12px; text-align:center; color:#6c7a86;">Sin líneas</div>';
        return;
      }
      const byCat = {};
      for (const l of lines) {
        const k = l.categoria || 'Sin categoría';
        if (k === 'Sin categoría') continue;
        byCat[k] = byCat[k] || { total: 0, count: 0 };
        byCat[k].total += Number(l.total || 0);
        byCat[k].count += 1;
      }
      const cards = Object.entries(byCat).map(([cat, info]) => `
        <div class="item-card">
          <img class="item-thumb" src="${escapeHtml(pickCategoryImage(cat))}" alt="">
          <div class="item-body">
            <h4>${escapeHtml(cat)}</h4>
            <div class="muted">Items: ${info.count}</div>
            <div><strong>${fmtCLP(info.total)}</strong></div>
          </div>
        </div>
      `).join('');
      overlayGrid.innerHTML = `<div class="item-grid">${cards}</div>`;
    }

    async function openLC(blockId, title) {
      ensureEls();
      currentBlockId = blockId;
      if (!overlayLC || !overlayLCGrid || !overlayLCTitle) return;
      overlayLCTitle.textContent = 'Lista de compras - ' + (title || blockId);
      overlayLC.classList.add('active'); document.body.classList.add('overlay-open');
      try {
        await loadLines(blockId);
      } catch (e) {
        console.error(e);
        overlayLCGrid.innerHTML = '<div style="padding:12px; color:#c00;">Error cargando líneas</div>';
      }
    }

    async function openSummary(blockId, title) {
      ensureEls();
      if (!overlay || !overlayGrid || !overlayTitle) return;
      overlayTitle.textContent = 'Ver resumen - ' + (title || blockId);
      overlay.classList.add('active'); document.body.classList.add('overlay-open');
      try {
        await loadCategoryImages();
        const lines = await fetchLines(blockId);
        renderSummary(lines);
      } catch (e) {
        console.error(e);
        overlayGrid.innerHTML = '<div style="padding:12px; color:#c00;">Error cargando resumen</div>';
      }
    }

    function fmtCLP(n) { return Number(n || 0).toLocaleString('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }); }
    function formatDate(d) { return d ? new Date(d).toLocaleDateString('es-CL') : '-'; }
    function escapeHtml(str) { if (str === undefined || str === null) return ''; return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>
</body>
</html>
