<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Configuraci√≥n - Proveedores</title>
  <link rel="stylesheet" href="../styles/global.css">
  <style>
    body {
      font-family: 'Inter', 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background: #f6f7f8;
      color: #2d2d2d;
    }

    .container {
      max-width: 1100px;
      margin: 36px auto 48px;
      padding: 0 16px;
    }

    h2 {
      font-size: 26px;
      font-weight: 800;
      margin-top: 0;
      margin-bottom: 14px;
      color: var(--primary, #35564c);
    }
    .muted { color: #6c7a86; font-size: 14px; }
    .small { font-size: 13px; }
    .banner {
      padding: 14px 16px;
      border-radius: 10px;
      margin: 10px 0 18px;
      font-weight: 600;
      background: #e7f5ea;
      color: #21402a;
      border: 1.5px solid #bbdcc7;
      font-size: 15px;
    }
    .banner.error {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #a2162b;
    }
    .banner.warning {
      background: #fff3cd;
      border-color: #ffeeba;
      color: #856404;
    }

    .card {
      background: #fff;
      border: 1px solid #e4e7eb;
      border-radius: 18px;
      box-shadow: 0 6px 22px rgba(44,80,45,0.05);
      padding: 20px 18px;
      margin-bottom: 32px;
    }

    .providers-header-bar {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom:18px;
      padding: 0 4px;
    }
    .providers-header-bar .right {
      flex: 1;
      text-align: right;
    }

    table.providers-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 14px rgba(55,80,44,0.07);
      margin-top: 0;
    }
    table.providers-table th,
    table.providers-table td {
      padding: 12px 13px;
      font-size: 15px;
    }
    table.providers-table th {
      background: #eef3f2;
      color: #285347;
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1.5px solid #e6efe9;
    }
    table.providers-table td {
      border-bottom: 1px solid #e6efe9;
      background: #fff;
    }
    table.providers-table tr:last-child td {
      border-bottom: none;
    }
    .no-rows {
      text-align: center;
      color: #6c7a86;
      font-size: 16px;
      padding: 50px 0;
    }

    /* Switch visual para 'Activo' */
    .switch {
      position: relative;
      display: inline-block;
      width: 42px;
      height: 24px;
    }
    .switch input {
      opacity: 0; width: 0; height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #c3d5cb;
      border-radius: 24px;
      transition: .4s;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: .2s;
    }
    input:checked + .slider {
      background: #36b37e;
    }
    input:checked + .slider:before {
      transform: translateX(18px);
      background: #f7fef9;
    }
    .switch-label {
      margin-left: 10px;
      color: #285347;
      font-size:14px;
      vertical-align: middle;
    }

    .button,
    button {
      background: var(--primary, #35564c);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 9px 18px;
      font-weight: 700;
      cursor: pointer;
      font-size: 15px;
      transition: background 0.18s;
      box-shadow: 0 5px 14px rgba(55,80,44,0.12);
      margin-bottom: 3px;
    }
    .button.secondary, button.secondary {
      background: #e3e9ed;
      color: #35564c;
      border: 1.5px solid #bbdcc7;
      box-shadow: none;
    }
    .button.danger, button.danger {
      background: #d95050;
      color: #fff;
      border: 1.5px solid #c64141;
    }
    .button.ghost, button.ghost {
      background: #f4f7f8;
      color: #35564c;
      border: none;
      box-shadow: none;
    }
    .button.sm, button.sm {
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 8px;
    }
    .actions {display:flex;gap:6px;}
    .actions .button, .actions button {margin:0;}
    .center { text-align: center; }

    /* Modal */
    .modal-overlay {
      position: fixed; z-index: 99999; top:0; left:0; right:0; bottom:0;
      background: rgba(50,70,60,0.18);
      display: flex; align-items: center; justify-content: center;
    }
    .modal {
      background: #fff;
      border-radius: 15px;
      padding: 32px 26px 26px 26px;
      box-shadow: 0 14px 60px rgba(35,80,52,0.13);
      min-width: 340px;
      max-width: 94vw;
      position: relative;
      animation: modalIn .12s cubic-bezier(.74,-0.04,.93,.82);
    }
    @keyframes modalIn {
      from { opacity:0; transform: translateY(38px) scale(0.99);}
      to { opacity:1; transform:none;}
    }
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #2e5e4e;
      margin-bottom: 18px;
      margin-top: 0;
    }
    .modal-body .form-row {
      margin-bottom: 16px;
    }
    .modal label {display:block;font-size:13px;font-weight:600;color:#294538;margin-bottom:7px;}
    .modal input[type="text"], .modal input[type="url"], .modal input[type="tel"] {
      width: 100%;
      padding: 10px 12px;
      border: 1.4px solid #dfe3e6;
      border-radius: 9px;
      font-size: 15px;
      background: #f7faf8;
      box-sizing: border-box;
      font-family:inherit;
      margin-bottom:4px;
    }
    .modal .switch {vertical-align: middle;}
    .modal .modal-actions {
      margin-top: 22px;
      display: flex;
      gap: 14px;
      justify-content: flex-end;
    }
    .close-x {
      position: absolute;
      top: 16px; right: 18px;
      background: none;
      border: none;
      font-size: 22px;
      color: #455;
      cursor: pointer;
    }
    @media (max-width: 600px){
      .container{max-width:100%;padding:0 5px;}
      .modal{min-width:98vw;}
      table.providers-table th,table.providers-table td{font-size:12px;padding:7px;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Configuraci√≥n ‚Äî Proveedores</h2>
    <div id="banner-container" aria-live="polite"></div>

    <div class="providers-header-bar">
      <button class="button" id="btnNew"><span style="font-size:19px;vertical-align:middle;">Ôºã</span> Nuevo Proveedor</button>
      <button class="button secondary" id="btnReload">Recargar</button>
      <button class="button ghost" id="btnDemo" title="Activar modo demo/local" style="display:none">Modo Demo</button>
      <div class="right"><span id="statusText" class="muted small"></span></div>
    </div>

    <div id="connectArea" class="card" style="display:none;">
      <div class="muted small">No se detect√≥ una conexi√≥n con Supabase. Puedes pegar credenciales temporales (solo para pruebas) o usar Modo Demo.</div>
      <div class="modal-body" style="margin-top:8px;">
        <div class="form-row"><label class="small">Supabase URL</label>
        <input id="connUrl" type="url" placeholder="https://xyz.supabase.co" /></div>
        <div class="form-row"><label class="small">ANON KEY</label>
        <input id="connKey" type="password" placeholder="eyJhbGciOi..." /></div>
        <div class="form-row" style="display:flex;gap:8px;">
          <button class="button" id="btnConnect">Conectar</button>
          <button class="button secondary" id="btnUseDemo">Modo Demo</button>
          <button class="button ghost" id="btnCancelConnect">Cancelar</button>
        </div>
      </div>
    </div>

    <div class="card" style="padding:0;overflow:auto;">
      <table class="providers-table" id="providersTable" aria-label="Proveedores">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Website</th>
            <th>Tel√©fono</th>
            <th class="center">Activo</th>
            <th>Creado</th>
            <th class="center">Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal (dynamic) -->
    <div id="providerModalOverlay" class="modal-overlay" style="display:none;" tabindex="-1">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="prov-modal-title">
        <button class="close-x" onclick="closeProviderModal()">√ó</button>
        <h3 class="modal-title" id="prov-modal-title">Proveedor</h3>
        <div class="modal-body">
          <div class="form-row"><label>Nombre*</label> <input type="text" id="prov-modal-name" autocomplete="off" required /></div>
          <div class="form-row"><label>Website</label> <input type="url" id="prov-modal-website" autocomplete="off" /></div>
          <div class="form-row"><label>Tel√©fono</label> <input type="text" id="prov-modal-phone" autocomplete="off" /></div>
          <div class="form-row">
            <label style="display:inline-block;margin-right:12px;">Activo</label>
            <label class="switch" style="vertical-align:middle;">
              <input type="checkbox" id="prov-modal-active"><span class="slider"></span>
            </label>
          </div>
        </div>
        <div class="modal-actions">
          <button class="button sm" id="prov-modal-save">Guardar</button>
          <button class="button ghost sm" onclick="closeProviderModal()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
  <script type="module">
    // --- tu JS backend y l√≥gica se mantiene EXACTAMENTE igual, solo agrego helpers de modal/UX
    import * as apiModule from '../../lib/providersApi.js';
    import { ensureSupabase, initializeSupabase } from '../../js/supabaseBrowserClient.js';

    let currentEditProvider = null;
    let isNew = false;
    const tbody = document.querySelector('#providersTable tbody');
    const btnNew = document.getElementById('btnNew');
    const btnReload = document.getElementById('btnReload');
    const btnDemo = document.getElementById('btnDemo');
    const bannerContainer = document.getElementById('banner-container');
    const connectArea = document.getElementById('connectArea');
    const connUrl = document.getElementById('connUrl');
    const connKey = document.getElementById('connKey');
    const btnConnect = document.getElementById('btnConnect');
    const btnUseDemo = document.getElementById('btnUseDemo');
    const btnCancelConnect = document.getElementById('btnCancelConnect');
    const statusText = document.getElementById('statusText');
    // NEW: Modal
    const modalOverlay = document.getElementById('providerModalOverlay');
    const modal = modalOverlay?.querySelector('.modal');
    const modalName = document.getElementById('prov-modal-name');
    const modalWebsite = document.getElementById('prov-modal-website');
    const modalPhone = document.getElementById('prov-modal-phone');
    const modalActive = document.getElementById('prov-modal-active');
    const modalSave = document.getElementById('prov-modal-save');
    let modalOnSave = null;

    // Modal helpers
    function openProviderModal(provider, onSave) {
      modalOverlay.style.display = 'flex';
      modalName.value = provider?.name || '';
      modalWebsite.value = provider?.website || '';
      modalPhone.value = provider?.phone || '';
      modalActive.checked = provider?.active !== false;
      modalOnSave = onSave;
      modalName.focus();
      setTimeout(()=>{ modalName.focus(); }, 100);
    }
    function closeProviderModal() {
      modalOverlay.style.display = 'none';
      modalOnSave = null;
    }
    modalOverlay.addEventListener('click', e=>{
      if(e.target === modalOverlay) closeProviderModal();
    });
    document.addEventListener('keydown', e=>{
      if (modalOverlay.style.display === 'flex' && e.key === 'Escape') closeProviderModal();
    });
    modalSave.onclick = function() {
      const obj = {
        name: modalName.value.trim(),
        website: modalWebsite.value.trim(),
        phone: modalPhone.value.trim(),
        active: modalActive.checked
      };
      if (!obj.name) { alert('Debes ingresar nombre'); return; }
      if(modalOnSave) modalOnSave(obj);
    };

    // Proveedor demo/identica l√≥gica a la tuya: helpers abajo
    // .... Copia y pega el RESTO DE TU JS sin cambios...
    // --- copia aqu√≠ todo tu JS como ven√≠a en tu archivo original desde "function escapeHtml..." hacia abajo,
    // --- sin tocar nada, y donde renderizabas las filas cambia para que los botones usen openProviderModal.

    // (1) Reemplaza prompt de nuevo por modal:
    btnNew.addEventListener('click', () => {
      isNew = true;
      openProviderModal({name:'',website:'',phone:'',active:true}, async (obj) => {
        try {
          if (isDemoMode()) {
            createDemoProvider(obj);
            closeProviderModal();
            await loadAdminProviders({ forceDemo: true });
            return;
          }
          const res = await apiModule.createProvider(obj);
          if (res.error) { alert('Error creando proveedor: '+(res.error.message||JSON.stringify(res.error))); return; }
          closeProviderModal();
          await loadAdminProviders();
        } catch(e){ alert('Error creando proveedor: '+(e.message||e));}
      });
    });

    // (2) EN RENDER ROWS, agrega bot√≥n editar (lapiz) y muda edici√≥n a modal:
    function renderProviders(list) {
      tbody.innerHTML = '';
      list.forEach(p => {
        const tr = document.createElement('tr');
        tr.dataset.id = p.id || '';
        tr.innerHTML = `
          <td>${escapeHtml(p.name||'')}</td>
          <td>${escapeHtml(p.website||'')}</td>
          <td>${escapeHtml(p.phone||'')}</td>
          <td class="center">
            <label class="switch" style="margin:0;">
              <input type="checkbox" ${p.active ? 'checked' : ''} disabled><span class="slider"></span>
            </label>
          </td>
          <td>${p.created_at ? new Date(p.created_at).toLocaleString() : '-'}</td>
          <td class="actions center">
            <button class="button secondary sm btnEdit" title="Editar"><span style="font-size:17px;">‚úèÔ∏è</span></button>
            <button class="button danger sm btnDelete" title="Eliminar">üóëÔ∏è</button>
            <button class="button secondary sm btnToggle" title="Activar/Desactivar">${p.active ? 'Desactivar' : 'Activar'}</button>
          </td>
        `;
        tbody.appendChild(tr);

        // Editar
        tr.querySelector('.btnEdit').onclick = () => {
          openProviderModal(p, async (obj) => {
            if (isDemoMode()) {
              updateDemoProvider(p.id, obj);
              closeProviderModal();
              await loadAdminProviders({ forceDemo: true });
              return;
            }
            try {
              const res = await apiModule.updateProvider(p.id, obj);
              if (res.error) { alert('Error actualizando proveedor: ' + (res.error.message || JSON.stringify(res.error))); return; }
              closeProviderModal();
              await loadAdminProviders();
            } catch(e){ alert('Error actualizando proveedor: ' + (e.message || e)); }
          });
        };
        // Eliminar
        tr.querySelector('.btnDelete').onclick = async () => {
          if (!confirm('¬øEliminar proveedor "'+escapeHtml(p.name)+'"?')) return;
          if (isDemoMode()) {
            deleteDemoProvider(p.id);
            await loadAdminProviders({ forceDemo: true });
            return;
          }
          try {
            await apiModule.deleteProvider(p.id, { soft: true });
            await loadAdminProviders();
          } catch (err) {
            alert('Error eliminando proveedor: ' + (err.message || err));
          }
        };
        // Activar/desactivar
        tr.querySelector('.btnToggle').onclick = async () => {
          const newActive = !p.active;
          if (isDemoMode()) {
            updateDemoProvider(p.id, { active: newActive });
            await loadAdminProviders({ forceDemo: true });
            return;
          }
          try {
            await apiModule.updateProvider(p.id, { active: newActive });
            await loadAdminProviders();
          } catch (err) {
            alert('Error cambiando activo: ' + (err.message || err));
          }
        };
      });
    }

    // El resto de helpers/backend/DEMO que ya tienes, copiar+pegar debajo.

    // ... (El resto de tus helpers aqu√≠, igual como ven√≠a) ...
    // Repite el resto del JS original (funciones helpers, reload, connectArea, demoMode...)
    // ...
    // TODO: copia desde function escapeHtml(s) { ... } hacia abajo de tu original aqu√≠.

  </script>
  <script>
    function closeProviderModal() {
      document.getElementById('providerModalOverlay').style.display = 'none';
    }
  </script>
</body>
</html>
