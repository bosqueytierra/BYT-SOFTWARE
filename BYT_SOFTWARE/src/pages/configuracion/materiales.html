<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Materiales - BYT SOFTWARE</title>
    <link rel="stylesheet" href="../../styles/global.css">
    <style>
        :root {
            --primary: #2e7d32;
            --primary-dark: #245f28;
            --secondary: #6c757d;
            --danger: #c62828;
            --warning: #f5a524;
            --muted: #4a5568;
            --bg: #f5f6f7;
            --card: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --radius: 12px;
        }
        body { background: var(--bg); color: #2b2d42; }
        h1,h2,h3,h4 { color: #1f2937; margin: 0; }
        .header-title { font-size: 22px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 18px; border-bottom: 1px solid #e5e7eb; }
        .tab { padding: 12px 18px; background: none; border: none; cursor: pointer; font-size: 15px; color: #6b7280; border-bottom: 3px solid transparent; border-radius: 8px 8px 0 0; transition: all .2s; }
        .tab:hover { color: var(--primary-dark); background: rgba(46,125,50,0.08); }
        .tab.active { color: var(--primary-dark); border-bottom-color: var(--primary-dark); font-weight: 700; background: rgba(46,125,50,0.08); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid #edf0f4; }
        .search-section { background: var(--card); padding: 18px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 16px; border: 1px solid #edf0f4; }
        .search-row { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 220px; }
        .form-group label { display: block; margin-bottom: 6px; color: #374151; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; background: #fff;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: 2px solid rgba(46,125,50,0.15); border-color: var(--primary);
        }
        .simple-table-container { overflow-x: auto; }
        .simple-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .simple-table th, .simple-table td { padding: 12px; text-align: left; border-bottom: 1px solid #f0f2f5; }
        .simple-table th { background: #f8fafc; color: #2f3e46; font-weight: 700; }
        .simple-table tr:hover { background: #f9fafb; }
        .btn { background: var(--primary); color: white; padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; font-weight: 600; transition: all .15s; box-shadow: 0 6px 14px rgba(46,125,50,0.22); }
        .btn:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--secondary); color: white; padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; font-weight: 600; }
        .btn-secondary:hover { background: #565e64; }
        .btn-danger { background: var(--danger); color: white; padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; font-weight: 600; box-shadow: 0 6px 14px rgba(198,40,40,0.22); }
        .btn-danger:hover { background: #a32020; }
        .btn-small { padding: 6px 10px; font-size: 12px; border-radius: 8px; }
        .material-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; background: #fff; margin-bottom: 5px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .material-info { flex: 1; }
        .muted { color: #6b7280; }

        /* Toast & modal */
        .toast-container { position: fixed; top: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 260px; background: #fff; color: #1f2937; padding: 14px 16px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); border-left: 5px solid var(--primary); font-size: 14px; }
        .toast.success { border-left-color: #4caf50; }
        .toast.error { border-left-color: #e53935; }
        .toast.warning { border-left-color: #f5a524; }
        .toast.info { border-left-color: #2196f3; }

        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 9998; }
        .modal { background: #fff; padding: 22px; border-radius: 14px; width: 420px; max-width: 90%; box-shadow: 0 16px 40px rgba(0,0,0,0.25); border: 1px solid #e5e7eb; }
        .modal h3 { margin: 0 0 8px 0; font-size: 18px; color: #111827; }
        .modal p { margin: 0 0 14px 0; color: #374151; line-height: 1.5; }
        .modal .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 14px; }

        /* Success center modal */
        #successBackdrop { z-index: 9997; }

        /* Hold-to-delete in modal */
        .hold-zone { width: 100%; background: #f3f4f6; border-radius: 10px; padding: 10px; border: 1px solid #e5e7eb; }
        .hold-btn { position: relative; overflow: hidden; width: 100%; justify-content: center; display: inline-flex; align-items: center; gap: 8px; }
        .hold-progress { position: absolute; inset: 0; background: rgba(0,0,0,0.12); width: 0%; transition: width linear; pointer-events: none; border-radius: 10px; }
        .badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(46,125,50,0.1); color: var(--primary-dark); padding: 6px 10px; border-radius: 999px; font-weight: 600; font-size: 13px; }
    </style>
</head>
<body>
    <div id="page-content">
        <div class="container">
            <header class="header">
                <div class="header-content">
                    <div class="logo-section">
                        <img src="../../assets/logo_byt.png" alt="Logo BYT" class="logo" style="width:48px;height:48px;margin-right:12px;">
                        <div>
                            <h1 class="header-title">Gesti√≥n de Materiales</h1>
                            <p class="header-subtitle muted">Administraci√≥n de Materiales y Categor√≠as</p>
                        </div>
                    </div>
                </div>
            </header>

            <main>
                <div class="tabs" role="tablist" aria-label="Gesti√≥n de materiales">
                    <button class="tab active" onclick="showTab('categorias')" role="tab" aria-selected="true">üìÅ Categor√≠as</button>
                    <button class="tab" onclick="showTab('consultar')" role="tab">üîç Consultar Materiales</button>
                    <button class="tab" onclick="showTab('crear')" role="tab">‚ûï Crear Material</button>
                    <button class="tab" onclick="showTab('editar')" role="tab">‚úèÔ∏è Editar Material</button>
                    <button class="tab" onclick="showTab('eliminar')" role="tab">üóëÔ∏è Eliminar Material</button>
                </div>

                <div id="categorias" class="tab-content active" role="tabpanel">
                    <div class="card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h2 class="card-title">üìÅ Gesti√≥n de Categor√≠as</h2>
                            <button class="btn" onclick="mostrarModalAgregarCategoria()">+ Nueva Categor√≠a</button>
                        </div>
                        <div style="background:#fff8e1;border:1px solid #ffeaa7;border-radius:10px;padding:14px;margin-bottom:16px;">
                            <p><strong>‚ÑπÔ∏è Informaci√≥n:</strong> En esta secci√≥n solo se gestionan las <strong>categor√≠as</strong>. Los materiales se gestionan en las pesta√±as correspondientes.</p>
                        </div>
                        <div class="simple-table-container">
                            <table class="simple-table">
                                <thead><tr><th>Categor√≠a</th><th>Cantidad de Materiales</th><th>Acciones</th></tr></thead>
                                <tbody id="tablaCategorias"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="consultar" class="tab-content" role="tabpanel">
                    <div class="search-section">
                        <h3>üîç Consultar Materiales (Solo Lectura)</h3>
                        <div class="search-row">
                            <div class="form-group">
                                <label>Seleccionar Categor√≠a *</label>
                                <select id="consultarCategoria" onchange="consultarMaterialesPorCategoria()">
                                    <option value="">-- Seleccione una categor√≠a --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Buscar por nombre (opcional)</label>
                                <input type="text" id="filtroNombre" placeholder="Filtrar por nombre..." onkeyup="filtrarMateriales()">
                            </div>
                            <button class="btn" onclick="consultarTodosMateriales()">üìã Ver Todos</button>
                            <button class="btn-secondary" onclick="limpiarConsulta()">üóëÔ∏è Limpiar</button>
                        </div>
                    </div>

                    <div class="card">
                        <div style="background:#e7f3ff;border:1px solid #b3d7ff;border-radius:8px;padding:10px;margin-bottom:15px;">
                            <p style="margin:0;color:#0f60c4;font-size:13px;"><strong>üìñ Solo Consulta:</strong> Esta pesta√±a es √∫nicamente para ver materiales. Para modificar use las pesta√±as correspondientes.</p>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <h3 id="tituloResultados">Materiales por Categor√≠a</h3>
                            <div id="contadorMateriales" class="muted" style="font-size:13px;"></div>
                        </div>
                        <div id="consultarResultados" class="muted" style="padding:20px;text-align:center;">
                            üì¶ Seleccione una categor√≠a para ver sus materiales<br><small>o haga clic en "Ver Todos"</small>
                        </div>
                    </div>
                </div>

                <div id="crear" class="tab-content" role="tabpanel">
                    <div class="card">
                        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                            <span class="badge">‚ûï Crear</span>
                            <h2 class="card-title" style="margin:0;">Crear Nuevo Material</h2>
                        </div>
                        <form id="crearMaterialForm">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;">
                                <div class="form-group">
                                    <label>Categor√≠a *</label>
                                    <select id="crearCategoria" required>
                                        <option value="">Seleccione una categor√≠a</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Nombre del Material *</label>
                                    <input type="text" id="crearNombre" required placeholder="Ej: Melamina Blanca 18mm">
                                </div>
                                <div class="form-group">
                                    <label>Unidad de Medida</label>
                                    <select id="crearUnidad" onchange="handleUnidadChange(event,'crearUnidad')"></select>
                                </div>
                                <div class="form-group" style="grid-column:1/-1;">
                                    <label>Descripci√≥n</label>
                                    <textarea id="crearDescripcion" rows="3" placeholder="Descripci√≥n detallada del material..."></textarea>
                                </div>
                            </div>
                            <div style="text-align:center;margin-top:24px;display:flex;gap:12px;justify-content:center;">
                                <button type="button" class="btn-secondary" onclick="limpiarFormularioCrear()">üóëÔ∏è Limpiar</button>
                                <button type="submit" class="btn">‚úÖ Crear Material</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="editar" class="tab-content" role="tabpanel">
                    <div class="search-section">
                        <h3>‚úèÔ∏è Buscar Material a Editar</h3>
                        <div class="search-row">
                            <div class="form-group">
                                <label>Categor√≠a</label>
                                <select id="editarBuscarCategoria" onchange="cargarMaterialesParaEditar()">
                                    <option value="">-- Seleccione una categor√≠a --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Material</label>
                                <select id="editarBuscarMaterial" onchange="cargarDatosMaterialEditar()">
                                    <option value="">-- Primero seleccione una categor√≠a --</option>
                                </select>
                            </div>
                            <button class="btn" onclick="cargarDatosMaterialEditar()">üìù Cargar para Editar</button>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="card-title">‚úèÔ∏è Editar Material</h2>
                        <form id="editarMaterialForm">
                            <input type="hidden" id="editarSelectedId" value="">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;">
                                <div class="form-group">
                                    <label>Categor√≠a Original</label>
                                    <input type="text" id="editarCategoriaOriginal" readonly style="background:#f5f5f5;">
                                </div>
                                <div class="form-group">
                                    <label>Nombre Original</label>
                                    <input type="text" id="editarNombreOriginal" readonly style="background:#f5f5f5;">
                                </div>
                                <div class="form-group" style="grid-column:1/-1;">
                                    <label>Nuevo Nombre *</label>
                                    <input type="text" id="editarNuevoNombre" required placeholder="Nuevo nombre del material">
                                </div>
                            </div>
                            <div style="text-align:center;margin-top:24px;display:flex;gap:12px;justify-content:center;">
                                <button type="button" class="btn-secondary" onclick="limpiarFormularioEditar()">üóëÔ∏è Limpiar</button>
                                <button type="submit" class="btn">‚úèÔ∏è Actualizar Material</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="eliminar" class="tab-content" role="tabpanel">
                    <div class="search-section">
                        <h3>üóëÔ∏è Buscar Material a Eliminar</h3>
                        <div class="search-row">
                            <div class="form-group">
                                <label>Categor√≠a</label>
                                <select id="eliminarBuscarCategoria" onchange="cargarMaterialesParaEliminar()">
                                    <option value="">-- Seleccione una categor√≠a --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Material</label>
                                <select id="eliminarBuscarMaterial">
                                    <option value="">-- Primero seleccione una categor√≠a --</option>
                                </select>
                            </div>
                            <button id="btnHoldDelete" class="btn-danger hold-btn" type="button">
                                <span>üóëÔ∏è Eliminar Material</span>
                                <div class="hold-progress" id="holdProgress"></div>
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h3>‚ö†Ô∏è Zona de Eliminaci√≥n</h3>
                        <div style="background:#fff3cd;border:1px solid #ffeaa7;border-radius:10px;padding:16px;margin:12px 0;">
                            <p><strong>‚ö†Ô∏è Advertencia:</strong> La eliminaci√≥n de materiales es <strong>permanente</strong> y no se puede deshacer.</p>
                        </div>
                        <div id="materialAEliminar" style="display:none;background:#f8f9fa;padding:12px;border-radius:8px;margin:12px 0;">
                            <h4>Material seleccionado para eliminar:</h4>
                            <div id="datosMaterialEliminar"></div>
                        </div>
                        <div style="text-align:center;margin-top:16px;" class="muted">
                            Seleccione una categor√≠a y material arriba para proceder
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast / Modals -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="modal-backdrop" id="confirmBackdrop">
        <div class="modal">
            <h3 id="confirmTitle">Confirmar</h3>
            <p id="confirmMessage">¬øSeguro?</p>
            <div class="actions">
                <button class="btn-secondary" id="confirmCancel">Cancelar</button>
                <button class="btn" id="confirmOk">Aceptar</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="deleteBackdrop">
        <div class="modal">
            <h3>‚ö†Ô∏è Eliminar material</h3>
            <p id="deleteMessage"></p>
            <div class="hold-zone">
                <div style="font-size:13px;color:#374151;margin-bottom:8px;">Mant√©n presionado para confirmar (3s)</div>
                <button id="deleteHoldBtn" class="btn-danger hold-btn" type="button" style="width:100%;">
                    <span id="deleteHoldText">Mant√©n 3.0s para eliminar</span>
                    <div class="hold-progress" id="deleteHoldProgress"></div>
                </button>
            </div>
            <div class="actions" style="margin-top:14px;">
                <button class="btn-secondary" id="deleteCancel">Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="successBackdrop">
        <div class="modal" style="text-align:center;">
            <h3>‚úÖ Material creado</h3>
            <p id="successMessage">El material se cre√≥ correctamente.</p>
            <div class="actions" style="justify-content:center;">
                <button class="btn" id="successOk">Entendido</button>
            </div>
        </div>
    </div>

    <script src="../../js/categorias_reales.js"></script>
    <script src="../../js/menuConfig.js"></script>
    <script src="../../js/layout.js"></script>

    <script type="module">
    let materialsApi = null;
    let unitsApi = null;
    let remoteAvailable = false;
    let categoriesData = {};
    let unidades = [];
    let unitsMap = {};

    function toast(msg, type='info', timeout=2400) {
      const cont = document.getElementById('toastContainer');
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.textContent = msg;
      cont.appendChild(el);
      setTimeout(() => { el.style.opacity = '0'; setTimeout(()=>cont.removeChild(el),300); }, timeout);
    }

    function showSuccess(message='Material creado correctamente') {
      const back = document.getElementById('successBackdrop');
      document.getElementById('successMessage').textContent = message;
      back.style.display = 'flex';
      document.getElementById('successOk').onclick = () => { back.style.display='none'; };
    }

    function confirmDialog({title='Confirmar', message='¬øSeguro?', okText='Aceptar', cancelText='Cancelar'} = {}) {
      return new Promise(res => {
        const back = document.getElementById('confirmBackdrop');
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmOk').textContent = okText;
        document.getElementById('confirmCancel').textContent = cancelText;
        back.style.display = 'flex';
        const clean = () => { back.style.display = 'none'; ok.onclick = cancel.onclick = null; };
        const ok = document.getElementById('confirmOk');
        const cancel = document.getElementById('confirmCancel');
        ok.onclick = () => { clean(); res(true); };
        cancel.onclick = () => { clean(); res(false); };
      });
    }

    function openDeleteModal({ categoria, nombre, remoteId }) {
      const back = document.getElementById('deleteBackdrop');
      const msg = `¬øSeguro que deseas eliminar "${nombre}" en la categor√≠a "${categoria}"?`;
      document.getElementById('deleteMessage').textContent = msg;
      back.style.display = 'flex';
      setupDeleteHold(remoteId, categoria, nombre);
    }
    function closeDeleteModal() { document.getElementById('deleteBackdrop').style.display = 'none'; }

    function renderUnidades(selectId, selected='') {
      const sel = document.getElementById(selectId);
      sel.innerHTML = '';
      unidades.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u; opt.textContent = unitsMap[u]?.name || u;
        if (u === selected) opt.selected = true;
        sel.appendChild(opt);
      });
      const optAdd = document.createElement('option');
      optAdd.value = '__add__'; optAdd.textContent = 'Ôºã Agregar nueva unidad‚Ä¶';
      sel.appendChild(optAdd);
    }

    async function handleUnidadChange(ev, selectId) {
      const v = ev.target.value;
      if (v === '__add__') {
        const nueva = prompt('Ingrese nueva unidad (ej: ‚Äúbolsa‚Äù)');
        if (!nueva || !nueva.trim()) { renderUnidades(selectId); return; }
        const code = nueva.trim();
        try {
          const api = unitsApi || await import('../../lib/unitsApi.js');
          unitsApi = api;
          const res = await api.createUnit({ code, name: code, active: true });
          if (res.error) throw res.error;
          await refreshUnits();
          renderUnidades(selectId, code);
        } catch(err) {
          console.error('Error creando unidad', err);
          toast('Error creando unidad (ver consola)','error');
          renderUnidades(selectId);
        }
      }
    }

    async function refreshUnits() {
      try {
        const api = unitsApi || await import('../../lib/unitsApi.js');
        unitsApi = api;
        const res = await api.listUnits({ onlyActive: true });
        if (!res.error && Array.isArray(res.data)) {
          unidades = res.data.map(u => u.code);
          unitsMap = res.data.reduce((acc,u)=>{ acc[u.code]=u; return acc; }, {});
          return;
        }
      } catch(e) {
        console.warn('units fallback local', e);
      }
      unidades = ['pza','mt','m2','kg','lt','caja','par'];
      unitsMap = {};
    }

    async function initDataLayer() {
      try {
        const mod = await import('../../lib/materialsApi.js');
        materialsApi = mod;
        try {
          const res = await materialsApi.listMaterials({ onlyActive: false });
          if (!res?.error) {
            remoteAvailable = true;
            buildCategoriesFromMaterialsArray(res.data || []);
            console.log('Materials API connected - using Supabase materials');
          } else {
            console.warn('materialsApi.listMaterials returned error, falling back to local categories:', res.error);
            buildCategoriesFromLocal();
          }
        } catch (err) {
          console.warn('materialsApi.listMaterials threw, fallback to local:', err);
          buildCategoriesFromLocal();
        }
      } catch (err) {
        console.warn('No materialsApi available, using local categories fallback.', err);
        buildCategoriesFromLocal();
      }
      await refreshUnits();
    }

    function buildCategoriesFromMaterialsArray(arr) {
      categoriesData = {};
      arr.forEach(m => {
        const cat = m.category || 'Sin categor√≠a';
        if (!categoriesData[cat]) categoriesData[cat] = [];
        categoriesData[cat].push({
          id: m.id,
          name: m.name,
          price: m.price,
          unit: m.unit,
          active: m.active
        });
      });
    }

    function buildCategoriesFromLocal() {
      categoriesData = {};
      if (window.categoriasMateriales && typeof window.categoriasMateriales === 'object') {
        Object.keys(window.categoriasMateriales).forEach(cat => {
          const arr = window.categoriasMateriales[cat] || [];
          categoriesData[cat] = arr.map(name => ({ name }));
        });
      } else {
        categoriesData = {};
      }
    }

    function getAllMaterialsArray() {
      const out = [];
      Object.keys(categoriesData).forEach(cat => {
        categoriesData[cat].forEach(item => {
          out.push({
            category: cat,
            id: item.id,
            name: item.name,
            price: item.price,
            unit: item.unit,
            active: item.active === undefined ? true : item.active
          });
        });
      });
      return out;
    }

    function notifyUpdate() {
      try {
        const bc = new BroadcastChannel('byt-materials');
        bc.postMessage({ type: 'materials-updated', ts: Date.now() });
        bc.close();
      } catch (e) {}
      try { localStorage.setItem('byt_materials_updated_at', Date.now()); } catch(e){}
    }

    function loadCategories() {
      const tbody = document.getElementById('tablaCategorias');
      tbody.innerHTML = '';
      Object.keys(categoriesData).forEach(categoria => {
        const materiales = categoriesData[categoria] || [];
        const cantidadMateriales = materiales.length;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${categoria}</strong></td>
            <td>${cantidadMateriales} material(es)</td>
            <td>
                <button class="btn-secondary btn-small" onclick="editarCategoria('${escapeJs(categoria)}')" title="Editar categor√≠a">‚úèÔ∏è</button>
                <button class="btn-danger btn-small" onclick="eliminarCategoria('${escapeJs(categoria)}')" title="Eliminar categor√≠a">üóëÔ∏è</button>
            </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function mostrarModalAgregarCategoria() {
      const nombreCategoria = prompt('Ingrese el nombre de la nueva categor√≠a:');
      if (!nombreCategoria || !nombreCategoria.trim()) return;
      const nombre = nombreCategoria.trim();
      if (categoriesData[nombre]) { toast('Ya existe una categor√≠a con ese nombre','warning'); return; }
      categoriesData[nombre] = [];
      if (window.categoriasMateriales) window.categoriasMateriales[nombre] = [];
      loadCategories();
      actualizarTodosLosSelects();
      toast('Categor√≠a creada','success');
    }

    async function editarCategoria(categoriaActual) {
      const nuevoNombre = prompt(`Editar nombre de categor√≠a:\nNombre actual: ${categoriaActual}`, categoriaActual);
      if (!nuevoNombre || !nuevoNombre.trim() || nuevoNombre.trim() === categoriaActual) return;
      const nombre = nuevoNombre.trim();
      if (categoriesData[nombre]) { toast('Ya existe una categor√≠a con ese nombre','warning'); return; }
      categoriesData[nombre] = categoriesData[categoriaActual] || [];
      delete categoriesData[categoriaActual];
      if (window.categoriasMateriales) {
        window.categoriasMateriales[nombre] = window.categoriasMateriales[categoriaActual] || [];
        delete window.categoriasMateriales[categoriaActual];
      }
      if (remoteAvailable) {
        const list = categoriesData[nombre];
        for (const item of list) {
          if (item.id) {
            try { await materialsApi.updateMaterial(item.id, { category: nombre }); }
            catch(e){ console.warn('Failed to update material category on remote for id', item.id, e); }
          }
        }
        await refreshFromRemote();
      }
      loadCategories();
      actualizarTodosLosSelects();
      toast('Categor√≠a actualizada','success');
    }

    async function eliminarCategoria(categoria) {
      const materiales = categoriesData[categoria] || [];
      const cantidadMateriales = materiales.length;
      const mensaje = cantidadMateriales > 0 
        ? `¬øEliminar la categor√≠a "${categoria}"?\nContiene ${cantidadMateriales} material(es) que tambi√©n se eliminar√°n.`
        : `¬øEliminar la categor√≠a "${categoria}"?`;
      const ok = await confirmDialog({ title:'Eliminar categor√≠a', message: mensaje, okText:'Eliminar', cancelText:'Cancelar' });
      if (!ok) return;
      if (remoteAvailable) {
        for (const m of materiales) {
          if (m.id) {
            try { await materialsApi.deleteMaterial(m.id, { soft: true }); }
            catch(e){ console.warn('Failed deleting material remotely', m.id, e); }
          }
        }
        await refreshFromRemote();
      } else {
        if (window.categoriasMateriales) delete window.categoriasMateriales[categoria];
        delete categoriesData[categoria];
      }
      loadCategories();
      actualizarTodosLosSelects();
      notifyUpdate();
      toast('Categor√≠a eliminada','success');
    }

    function loadConsultarCategories() {
      const select = document.getElementById('consultarCategoria');
      select.innerHTML = '<option value="">-- Seleccione una categor√≠a --</option>';
      Object.keys(categoriesData).forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        select.appendChild(option);
      });
    }
    function loadCrearCategories() {
      const select = document.getElementById('crearCategoria');
      select.innerHTML = '<option value="">Seleccione una categor√≠a</option>';
      Object.keys(categoriesData).forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        select.appendChild(option);
      });
      renderUnidades('crearUnidad');
    }
    function loadEditarCategories() {
      const select = document.getElementById('editarBuscarCategoria');
      select.innerHTML = '<option value="">-- Seleccione una categor√≠a --</option>';
      Object.keys(categoriesData).forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        select.appendChild(option);
      });
    }
    function loadEliminarCategories() {
      const select = document.getElementById('eliminarBuscarCategoria');
      select.innerHTML = '<option value="">-- Seleccione una categor√≠a --</option>';
      Object.keys(categoriesData).forEach(categoria => {
        const option = document.createElement('option');
        option.value = categoria;
        option.textContent = categoria;
        select.appendChild(option);
      });
    }
    function actualizarTodosLosSelects(){
      loadConsultarCategories();
      loadCrearCategories();
      loadEditarCategories();
      loadEliminarCategories();
    }

    function consultarMaterialesPorCategoria() {
      const categoria = document.getElementById('consultarCategoria').value;
      const resultsDiv = document.getElementById('consultarResultados');
      const tituloDiv = document.getElementById('tituloResultados');
      const contadorDiv = document.getElementById('contadorMateriales');
      if (!categoria) {
        resultsDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">üì¶ Seleccione una categor√≠a para ver sus materiales</p>';
        tituloDiv.textContent = 'Materiales por Categor√≠a';
        contadorDiv.textContent = '';
        return;
      }
      const materiales = (categoriesData[categoria] || []).map(item => ({ categoria, material: item.name || item }));
      tituloDiv.textContent = `Categor√≠a: ${categoria}`;
      contadorDiv.textContent = `${materiales.length} material(es)`;
      if (materiales.length === 0) {
        resultsDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">üì≠ Esta categor√≠a no tiene materiales</p>';
        return;
      }
      mostrarMateriales(materiales);
    }

    function consultarTodosMateriales() {
      const resultsDiv = document.getElementById('consultarResultados');
      const tituloDiv = document.getElementById('tituloResultados');
      const contadorDiv = document.getElementById('contadorMateriales');
      const todosMateriales = getAllMaterialsArray().map(m => ({ categoria: m.category, material: m.name }));
      tituloDiv.textContent = 'Todos los Materiales';
      contadorDiv.textContent = `${todosMateriales.length} material(es) total`;
      if (todosMateriales.length === 0) {
        resultsDiv.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">üì≠ No hay materiales en el sistema</p>';
        return;
      }
      todosMateriales.sort((a,b) => a.categoria !== b.categoria ? a.categoria.localeCompare(b.categoria) : a.material.localeCompare(b.material));
      mostrarMateriales(todosMateriales);
    }

    function filtrarMateriales() {
      const filtro = document.getElementById('filtroNombre').value.toLowerCase();
      const categoria = document.getElementById('consultarCategoria').value;
      if (!categoria && !filtro) return;
      let materiales = [];
      const all = getAllMaterialsArray();
      all.forEach(m => {
        if (categoria && m.category !== categoria) return;
        if (!filtro || (m.name || '').toLowerCase().includes(filtro)) {
          materiales.push({ categoria: m.category, material: m.name });
        }
      });
      const tituloDiv = document.getElementById('tituloResultados');
      const contadorDiv = document.getElementById('contadorMateriales');
      if (filtro) {
        tituloDiv.textContent = `B√∫squeda: "${filtro}"${categoria ? ` en ${categoria}` : ''}`;
        contadorDiv.textContent = `${materiales.length} resultado(s)`;
      } else if (categoria) {
        consultarMaterialesPorCategoria(); return;
      }
      if (materiales.length === 0) {
        document.getElementById('consultarResultados').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">üîç No se encontraron materiales</p>';
        return;
      }
      mostrarMateriales(materiales);
    }

    function mostrarMateriales(materiales) {
      const resultsDiv = document.getElementById('consultarResultados');
      resultsDiv.innerHTML = materiales.map(item => `
          <div class="material-item">
              <div class="material-info">
                  <div class="material-name">${escapeHtml(item.material)}</div>
                  <div class="material-category muted">Categor√≠a: <strong>${escapeHtml(item.categoria)}</strong></div>
              </div>
          </div>
      `).join('');
    }

    function limpiarConsulta() {
      document.getElementById('consultarCategoria').value = '';
      document.getElementById('filtroNombre').value = '';
      document.getElementById('consultarResultados').innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">üì¶ Seleccione una categor√≠a para ver sus materiales<br><small>o haga clic en "Ver Todos"</small></p>';
      document.getElementById('tituloResultados').textContent = 'Materiales por Categor√≠a';
      document.getElementById('contadorMateriales').textContent = '';
    }

    function limpiarFormularioCrear() { document.getElementById('crearMaterialForm').reset(); renderUnidades('crearUnidad'); }

    async function bindCrearSubmit() {
      const form = document.getElementById('crearMaterialForm');
      if (!form) { console.error('No se encontr√≥ crearMaterialForm'); return; }
      form.onsubmit = async (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        try {
          const api = materialsApi || await import('../../lib/materialsApi.js');
          const cat   = document.getElementById('crearCategoria').value;
          const name  = document.getElementById('crearNombre').value.trim();
          const unit  = document.getElementById('crearUnidad').value || '';
          const notes = document.getElementById('crearDescripcion').value || '';
          if (!cat || !name) { toast('Falta categor√≠a o nombre','warning'); return; }
          const res = await api.createMaterial({ name, category: cat, unit, price: 0, notes, active: true });
          console.log('POST result', res);
          if (res?.error) { toast('Error creando (ver consola)','error'); return; }
          await refreshFromRemote();
          notifyUpdate();
          loadCategories();
          actualizarTodosLosSelects();
          if (document.getElementById('consultar').classList.contains('active')) consultarTodosMateriales();
          showSuccess('El material se cre√≥ correctamente.');
        } catch (err) {
          console.error('Submit error', err);
          toast('Error en submit (consola)','error');
        }
      };
    }

    function cargarMaterialesParaEditar() {
      const categoria = document.getElementById('editarBuscarCategoria').value;
      const selectMaterial = document.getElementById('editarBuscarMaterial');
      selectMaterial.innerHTML = '<option value="">-- Seleccione un material --</option>';
      if (!categoria) { selectMaterial.innerHTML = '<option value="">-- Primero seleccione una categor√≠a --</option>'; return; }
      const materiales = categoriesData[categoria] || [];
      materiales.forEach(item => {
        const option = document.createElement('option');
        if (remoteAvailable) {
          option.value = item.id || item.name;
          option.dataset.id = item.id || '';
          option.textContent = item.name || '';
        } else {
          option.value = item.name || item;
          option.textContent = item.name || item;
        }
        selectMaterial.appendChild(option);
      });
    }

    function cargarDatosMaterialEditar() {
      const categoria = document.getElementById('editarBuscarCategoria').value;
      const select = document.getElementById('editarBuscarMaterial');
      const selectedVal = select.value;
      if (!categoria || !selectedVal) { toast('Seleccione categor√≠a y material','warning'); return; }
      const option = select.selectedOptions[0];
      const remoteId = option?.dataset?.id || null;
      let name = selectedVal;
      if (remoteId) {
        document.getElementById('editarSelectedId').value = remoteId;
      } else {
        document.getElementById('editarSelectedId').value = '';
      }
      document.getElementById('editarCategoriaOriginal').value = categoria;
      document.getElementById('editarNombreOriginal').value = name;
      document.getElementById('editarNuevoNombre').value = name;
    }

    async function resolveMaterialId(categoria, nombre) {
      try {
        const res = await materialsApi.listMaterials({ onlyActive: false });
        if (res?.data) {
          const row = res.data.find(r => r.category === categoria && r.name === nombre);
          return row?.id || null;
        }
      } catch (e) {
        console.warn('resolveMaterialId failed', e);
      }
      return null;
    }

    document.getElementById('editarMaterialForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const categoriaOriginal = document.getElementById('editarCategoriaOriginal').value;
      const nombreOriginal = document.getElementById('editarNombreOriginal').value;
      const nuevoNombre = document.getElementById('editarNuevoNombre').value.trim();
      let selectedId = document.getElementById('editarSelectedId').value || null;

      if (!nuevoNombre) { toast('Ingrese el nuevo nombre','warning'); return; }
      if (nuevoNombre !== nombreOriginal && (categoriesData[categoriaOriginal] || []).some(it => (it.name || it).toLowerCase() === nuevoNombre.toLowerCase())) {
        toast(`Ya existe "${nuevoNombre}" en "${categoriaOriginal}"`,'warning'); return;
      }

      // Intentar resolver ID si no lo tenemos y estamos en remoto
      if (remoteAvailable && !selectedId) {
        selectedId = await resolveMaterialId(categoriaOriginal, nombreOriginal);
        document.getElementById('editarSelectedId').value = selectedId || '';
      }

      if (remoteAvailable && selectedId) {
        try {
          const res = await materialsApi.updateMaterial(selectedId, { name: nuevoNombre });
          if (res?.error) throw res.error;
          await refreshFromRemote();
          notifyUpdate();
          toast('Material actualizado (remote)','success');
        } catch (e) {
          console.error('Error updating remote', e);
          toast('Error al actualizar en servidor','error');
        }
      } else {
        const arr = categoriesData[categoriaOriginal] || [];
        for (let i=0;i<arr.length;i++){
          const itm = arr[i];
          if ((itm.name || itm) === nombreOriginal) {
            if (typeof itm === 'string') arr[i] = nuevoNombre;
            else itm.name = nuevoNombre;
            break;
          }
        }
        if (window.categoriasMateriales && Array.isArray(window.categoriasMateriales[categoriaOriginal])) {
          const idx = window.categoriasMateriales[categoriaOriginal].indexOf(nombreOriginal);
          if (idx >= 0) window.categoriasMateriales[categoriaOriginal][idx] = nuevoNombre;
        }
        notifyUpdate();
        toast('Material actualizado (local)','success');
      }

      limpiarFormularioEditar();
      loadCategories();
      actualizarTodosLosSelects();
    });

    function limpiarFormularioEditar() {
      document.getElementById('editarMaterialForm').reset();
      document.getElementById('editarBuscarCategoria').value = '';
      document.getElementById('editarBuscarMaterial').innerHTML = '<option value="">-- Primero seleccione una categor√≠a --</option>';
      document.getElementById('editarSelectedId').value = '';
    }

    function cargarMaterialesParaEliminar() {
      const categoria = document.getElementById('eliminarBuscarCategoria').value;
      const selectMaterial = document.getElementById('eliminarBuscarMaterial');
      selectMaterial.innerHTML = '<option value="">-- Seleccione un material --</option>';
      if (!categoria) {
        selectMaterial.innerHTML = '<option value="">-- Primero seleccione una categor√≠a --</option>';
        document.getElementById('materialAEliminar').style.display = 'none';
        return;
      }
      const materiales = categoriesData[categoria] || [];
      materiales.forEach(item => {
        const option = document.createElement('option');
        if (remoteAvailable) {
          option.value = item.id || item.name;
          option.dataset.id = item.id || '';
          option.textContent = item.name || '';
        } else {
          option.value = item.name || item;
          option.textContent = item.name || item;
        }
        selectMaterial.appendChild(option);
      });
    }

    function setupDeleteHold(remoteId, categoria, name) {
      const btn = document.getElementById('deleteHoldBtn');
      const bar = document.getElementById('deleteHoldProgress');
      const text = document.getElementById('deleteHoldText');
      const cancel = document.getElementById('deleteCancel');
      let timer = null;
      const holdMs = 3000;
      const startHold = () => {
        if (timer) return;
        bar.style.transition = `width ${holdMs}ms linear`;
        bar.style.width = '100%';
        const start = Date.now();
        timer = setInterval(() => {
          const left = Math.max(0, holdMs - (Date.now()-start));
          text.textContent = `Mant√©n ${(left/1000).toFixed(1)}s para eliminar`;
          if (left <= 0) {
            clearInterval(timer); timer = null;
            bar.style.width = '0%'; bar.style.transition = '';
            deleteAction(remoteId, categoria, name);
            closeDeleteModal();
          }
        }, 100);
      };
      const cancelHold = () => {
        if (timer) { clearInterval(timer); timer = null; }
        bar.style.transition = '';
        bar.style.width = '0%';
        text.textContent = 'Mant√©n 3.0s para eliminar';
      };
      ['mousedown','touchstart'].forEach(ev => btn.addEventListener(ev, startHold, { once:false }));
      ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev => btn.addEventListener(ev, cancelHold, { once:false }));
      cancel.onclick = () => { cancelHold(); closeDeleteModal(); };
    }

    async function deleteAction(remoteId, categoria, name) {
      const select = document.getElementById('eliminarBuscarMaterial');
      if (remoteAvailable && remoteId) {
        try {
          const res = await materialsApi.deleteMaterial(remoteId, { soft: false });
          if (res?.error) throw res.error;
          await refreshFromRemote();
          notifyUpdate();
          toast('Material eliminado (Supabase)','success');
        } catch (e) {
          console.error('Error deleting remote', e);
          toast('Error al eliminar en servidor','error');
        }
      } else {
        const arr = categoriesData[categoria] || [];
        const idx = arr.findIndex(it => (it.name || it) === name);
        if (idx >= 0) arr.splice(idx, 1);
        if (window.categoriasMateriales && Array.isArray(window.categoriasMateriales[categoria])) {
          const idx2 = window.categoriasMateriales[categoria].indexOf(name);
          if (idx2 >= 0) window.categoriasMateriales[categoria].splice(idx2,1);
        }
        notifyUpdate();
        toast('Material eliminado (local)','success');
      }
      const prevCat = categoria;
      select.value = '';
      cargarMaterialesParaEliminar();
      document.getElementById('eliminarBuscarCategoria').value = prevCat;
      document.getElementById('materialAEliminar').style.display = 'none';
      loadCategories();
      actualizarTodosLosSelects();
      document.getElementById('eliminarBuscarCategoria').value = prevCat;
    }

    function setupDeleteButtonInline() {
      const btn = document.getElementById('btnHoldDelete');
      btn.onclick = () => {
        const categoria = document.getElementById('eliminarBuscarCategoria').value;
        const select = document.getElementById('eliminarBuscarMaterial');
        const selectedVal = select.value;
        if (!categoria || !selectedVal) { toast('Seleccione categor√≠a y material','warning'); return; }
        const option = select.selectedOptions[0];
        const remoteId = option?.dataset?.id || null;
        const name = selectedVal;
        openDeleteModal({ categoria, nombre: name, remoteId });
      };
    }

    async function refreshFromRemote() {
      if (!remoteAvailable || !materialsApi) return;
      try {
        const res = await materialsApi.listMaterials({ onlyActive: false });
        if (!res?.error) {
          buildCategoriesFromMaterialsArray(res.data || []);
        } else {
          console.warn('refreshFromRemote: error', res.error);
          buildCategoriesFromLocal();
        }
      } catch (e) {
        console.warn('refreshFromRemote exception', e);
        buildCategoriesFromLocal();
      }
    }

    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        try { event.target.classList.add('active'); } catch(e){}
        if (tabName === 'categorias') loadCategories();
        else if (tabName === 'consultar') loadConsultarCategories();
        else if (tabName === 'crear') { loadCrearCategories(); renderUnidades('crearUnidad'); }
        else if (tabName === 'editar') loadEditarCategories();
        else if (tabName === 'eliminar') { loadEliminarCategories(); setupDeleteButtonInline(); }
    }

    function escapeHtml(str){ if(!str) return ''; return str.replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[s]); }
    function escapeJs(s){ return (s+'').replace(/'/g,"\\'"); }

    (async function init(){
      await initDataLayer();
      loadCategories();
      actualizarTodosLosSelects();
      renderUnidades('crearUnidad');
      bindCrearSubmit();
      setupDeleteButtonInline();

      try {
        const bc = new BroadcastChannel('byt-materials');
        bc.onmessage = (ev) => { if (ev.data?.type === 'materials-updated') refreshFromRemote().then(()=>{ loadCategories(); actualizarTodosLosSelects(); renderUnidades('crearUnidad'); }); };
      } catch(e){}
      window.addEventListener('storage', (e) => { if (e.key === 'byt_materials_updated_at') { refreshFromRemote().then(()=>{ loadCategories(); actualizarTodosLosSelects(); renderUnidades('crearUnidad'); }); } });
    })();

    window.showTab = showTab;
    window.mostrarModalAgregarCategoria = mostrarModalAgregarCategoria;
    window.loadCategories = loadCategories;
    window.actualizarTodosLosSelects = actualizarTodosLosSelects;
    window.consultarTodosMateriales = consultarTodosMateriales;
    window.limpiarConsulta = limpiarConsulta;
    window.consultarMaterialesPorCategoria = consultarMaterialesPorCategoria;
    window.filtrarMateriales = filtrarMateriales;
    window.limpiarFormularioCrear = limpiarFormularioCrear;
    window.cargarMaterialesParaEditar = cargarMaterialesParaEditar;
    window.cargarDatosMaterialEditar = cargarDatosMaterialEditar;
    window.limpiarFormularioEditar = limpiarFormularioEditar;
    window.cargarMaterialesParaEliminar = cargarMaterialesParaEliminar;
    window.eliminarCategoria = eliminarCategoria;
    window.editarCategoria = editarCategoria;
    window.handleUnidadChange = handleUnidadChange;
    window.refreshFromRemote = refreshFromRemote;
    </script>
</body>
</html>
