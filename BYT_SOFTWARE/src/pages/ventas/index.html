<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ventas - BYT SOFTWARE</title>
  <link rel="stylesheet" href="../../styles/global.css">
  <style>
    :root {
      --bg: #f6f7f8;
      --card: #ffffff;
      --border: #e4e7eb;
      --text: #2d2d2d;
      --muted: #6c7a86;
      --primary: #2e5e4e;
      --primary-soft: #3f705d;
      --danger: #c0392b;
      --shadow: 0 6px 16px rgba(0,0,0,0.06);
      --selected: #e9f2ed;
      --dot-ok: #1f9d55;
      --dot-bad: #d64545;
      --st-en-ejecucion: #f6e0a3;
      --st-completada: #d6f5d6;
      --st-postventa: #f8d0d0;
      --chip-green: #e9f7ef;
      --chip-red: #fdeceb;
      --chip-green-text: #1f9d55;
      --chip-red-text: #d64545;
      --chip-neutral: #f2f3f5;
      --chip-neutral-text: #6c7a86;
    }
    body { margin:0; font-family:"Inter","SF Pro Display","Roboto",system-ui,sans-serif; background:var(--bg); color:var(--text); }
    .page { max-width: 1800px; width: 99%; margin: 22px auto 48px; padding: 0 28px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; box-shadow: var(--shadow); }
    .card + .card { margin-top: 14px; }
    .header-card { display:flex; justify-content:space-between; gap:12px; align-items:center; }
    .filters { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:10px; align-items:end; }
    label { font-size:13px; color:var(--muted); font-weight:600; margin-bottom:6px; display:block; }
    input, select {
      width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px;
      background: #fdfdfd; font-family: inherit; font-size: 14px; color: var(--text);
    }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align:left; font-size:14px; }
    th { color: var(--muted); font-weight:700; background: #fafafa; }
    tr.project-row { cursor:pointer; transition: background 0.15s ease; }
    tr.project-row:hover { background: #f5f8f7; }
    tr.project-row.selected { background: var(--selected); }
    .actions { display:flex; gap:8px; flex-wrap:nowrap; }
    .btn { border:1px solid var(--border); background:#fff; color:#1f2430; padding:9px 12px; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px; display:inline-flex; align-items:center; gap:6px; }
    .btn-ghost { background:#f0f3f5; color:#1f2430; }
    .layout-grid { display:grid; grid-template-columns: 2fr 1fr; gap:14px; align-items:start; }
    @media (max-width: 1100px) { .layout-grid { grid-template-columns: 1fr; } }
    .empty { padding:14px; color:var(--muted); text-align:center; }
    .state-icon { font-size:20px; display:inline-block; margin-right:6px; }
    .money { font-weight:700; color:var(--primary); }
    .table-title { margin:0 0 8px; font-size:16px; font-weight:800; }
    .subtext { color:var(--muted); font-size:13px; margin:0 0 8px; }
    .note-indicator { font-size:12px; color:var(--muted); display:inline-block; margin-left:6px; }
    select.state-select { min-width: 150px; background:#fff; }
    .state-select.st-en_ejecucion { background: var(--st-en_ejecucion); }
    .state-select.st-completada   { background: var(--st-completada); }
    .state-select.st-postventa    { background: var(--st-postventa); }
    .state-select.st-cancelada    { background: #fff; }
    select.state-select option { background: #fff; color: var(--text); }
    .dot-status { width: 14px; height: 14px; border-radius: 50%; display:inline-block; }
    .dot-ok { background: var(--dot-ok); }
    .dot-bad { background: var(--dot-bad); }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 12000; padding: 16px; }
    .modal { background: #fff; border-radius: 14px; border: 1px solid var(--border); box-shadow: 0 16px 40px rgba(0,0,0,0.12); width: min(520px, 100%); padding: 18px; }
    .modal h3 { margin: 0 0 8px; }
    .modal-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; flex-wrap:wrap; }
    textarea { width:100%; min-height:140px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-family:inherit; font-size:14px; background:#fdfdfd; }

    .diff-chip { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; font-weight:700; }
    .diff-pos { background: var(--chip-green); color: var(--chip-green-text); }
    .diff-neg { background: var(--chip-red); color: var(--chip-red-text); }
    .diff-neutral { background: var(--chip-neutral); color: var(--chip-neutral-text); }
    .diff-sign { font-size:18px; font-weight:800; }
    .resumen-row { display:flex; justify-content:space-between; align-items:center; margin:4px 0; }
    .resumen-label { color: var(--muted); font-size:13px; }
    .resumen-value { font-weight:700; }
    .resumen-divider { border:none; border-top:1px solid var(--border); margin:8px 0; }
  </style>
</head>
<body>
  <div class="page">
    <div class="card header-card">
      <div>
        <h2 style="margin:0;">Ventas</h2>
        <p style="margin:2px 0 0; color:var(--muted); font-size:13px;">Cotizaciones aprobadas. Selecciona un proyecto para ver sus partidas.</p>
      </div>
      <div class="actions">
        <a class="btn btn-ghost" href="dashboard.html">Ir a Dashboard</a>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;">Filtros</h3>
      <div class="filters">
        <div>
          <label>Buscar por proyecto o partida</label>
          <input id="filtro-texto" type="text" placeholder="Proyecto o partida..." oninput="aplicarFiltros()">
        </div>
        <div>
          <label>Estado</label>
          <select id="filtro-estado" onchange="aplicarFiltros()">
            <option value="todos">Todos</option>
            <option value="en_ejecucion">En ejecuci√≥n</option>
            <option value="completada">Completada</option>
            <option value="cancelada">Cancelada</option>
            <option value="postventa">Postventa</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;">Proyectos</h3>
      <p class="subtext">Selecciona un proyecto para ver sus partidas.</p>
      <div id="proyectos-wrapper"></div>
    </div>

    <div class="layout-grid">
      <div class="card">
        <h3 class="table-title" id="partidas-title">Partidas del proyecto</h3>
        <p class="subtext" id="partidas-subtitle">Selecciona un proyecto para ver sus partidas.</p>
        <div id="partidas-wrapper"></div>
      </div>
      <div class="card">
        <h3 class="table-title" id="resumen-title">Resumen</h3>
        <div id="resumen-wrapper"></div>
      </div>
    </div>
  </div>

  <!-- Modal de notas -->
  <div class="modal-backdrop" id="notes-modal">
    <div class="modal">
      <h3 id="notes-title">Observaciones</h3>
      <textarea id="notes-textarea" placeholder="Escribe observaciones..."></textarea>
      <div class="modal-actions">
        <button class="btn btn-ghost" type="button" onclick="closeNotesModal()">Cancelar</button>
        <button class="btn btn-primary" type="button" onclick="saveNotes()">Guardar</button>
      </div>
    </div>
  </div>

  <script src="../../js/menuConfig.js"></script>
  <script src="../../js/layout.js"></script>
  <script src="../../lib/supabaseConfig.js"></script>
  <script type="module" src="../../js/supabaseBrowserClient.js"></script>
  <script type="module" src="../../js/globalSupabase.js"></script>

  <script>
    const ESTADOS = ['en_ejecucion','completada','cancelada','postventa'];
    const MOTIVOS_BAJADA = [
      'Ajuste a presupuesto del cliente','Descuento comercial aplicado','Ajuste tributario (IVA u otros impuestos)',
      'Variaci√≥n en costos reales de compra','Modificaci√≥n de cantidades ejecutadas','Sustituci√≥n de materiales o proveedores',
      'Error en cotizaci√≥n inicial','Reajuste por plazos de entrega','Eliminaci√≥n de partidas no ejecutadas',
      'Ajuste por log√≠stica o transporte','Regularizaci√≥n administrativa'
    ];
    const MOTIVOS_SUBIDA = [
      'Aumento en costo de materiales','Aumento en costo de mano de obra','Incorporaci√≥n de trabajos adicionales',
      'Cambio en especificaciones del proyecto','Aumento por proveedor o marca seleccionada','Ajuste por variaci√≥n del tipo de cambio',
      'Incremento por urgencia en plazos','Costos adicionales de transporte o log√≠stica','Ajuste por condiciones del lugar de instalaci√≥n',
      'Reproceso o rectificaci√≥n solicitada por el cliente','Diferencia entre mediciones estimadas y reales',
      'Actualizaci√≥n de precios por vigencia de cotizaci√≥n','Ajuste por normativa o requerimientos t√©cnicos',
      'Aumento por disponibilidad de materiales','Ajuste por condiciones de pago'
    ];

    let ventasData = [];
    let ventasFiltradas = [];
    let proyectos = [];
    let selectedProyectoKey = null;
    const notesStore = new Map();
    let notesModalState = { partidaId: null, proyectoKey: null, proyectoNombre: '' };
    const proyectoCobradoMap = new Map();
    const motivoVariacionMap = new Map();

    document.addEventListener('DOMContentLoaded', async () => { await cargarVentas(); });

    async function cargarVentas() {
      const pw = document.getElementById('proyectos-wrapper');
      pw.innerHTML = '<div class="empty"><span class="state-icon">‚è≥</span>Cargando ventas...</div>';
      try {
        if (window.supabaseClient?.init) await window.supabaseClient.init();
        const res = await window.supabaseClient.listarVentas();
        if (!res.success) throw new Error(res.error);
        ventasData = res.data || [];
        ventasFiltradas = ventasData;
        aplicarFiltros();
      } catch (e) {
        console.error(e);
        pw.innerHTML = '<div class="empty"><span class="state-icon">‚ö†Ô∏è</span>Error cargando ventas</div>';
      }
    }

    function aplicarFiltros() {
      const txt = document.getElementById('filtro-texto').value.toLowerCase().trim();
      const est = document.getElementById('filtro-estado').value;
      ventasFiltradas = ventasData.filter(v => {
        const matchTxt = !txt ||
          (v.proyecto || '').toLowerCase().includes(txt) ||
          (v.partida_nombre || v.partida || '').toLowerCase().includes(txt);
        const matchEst = est === 'todos' ? true : (v.estado || 'en_ejecucion') === est;
        return matchTxt && matchEst;
      });
      buildProyectos();
      renderProyectos();
      renderPartidas();
      renderResumen();
    }

    function buildProyectos() {
      const map = new Map();
      ventasFiltradas.forEach(v => {
        const key = v.proyecto || 'Sin proyecto';
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(v);
      });
      proyectos = Array.from(map.entries()).map(([key, items]) => {
        const first = items[0] || {};
        const totalCotizadoBase = Number(first.total_cotizado || 0);
        const totalCobradoBase = Number(first.total_venta || 0);
        const totalCobrado = proyectoCobradoMap.has(key) ? proyectoCobradoMap.get(key) : totalCobradoBase;
        const cliente = formatCliente(first.cliente);
        const fechaCierre = first.fecha_aprobacion || first.fecha_cierre || first.fecha_cierre_max || '';
        const cotizacionId = first.cotizacion_id;
        const proyectoId = first.proyecto_id || key;
        const allGreen = items.every(it => ['completada','cancelada'].includes(it.estado || 'en_ejecucion'));
        const motivo = first.motivo_variacion;
        if (motivo && !motivoVariacionMap.has(key)) motivoVariacionMap.set(key, motivo);

        return {
          key,
          proyectoId,
          cotizacionId,
          cliente,
          fechaCierre,
          totalCobrado,      // usar solo un total por proyecto (no suma por partida)
          totalCotizado: totalCotizadoBase,
          items,
          allGreen
        };
      });
      if (!selectedProyectoKey && proyectos.length) selectedProyectoKey = proyectos[0].key;
      if (selectedProyectoKey && !proyectos.find(p => p.key === selectedProyectoKey)) selectedProyectoKey = null;
    }

    function renderProyectos() {
      const pw = document.getElementById('proyectos-wrapper');
      if (!proyectos.length) {
        pw.innerHTML = '<div class="empty"><span class="state-icon">üìÅ</span>No hay proyectos</div>';
        return;
      }
      const rows = proyectos.map(p => {
        const isSel = p.key === selectedProyectoKey;
        const dotClass = p.allGreen ? 'dot-ok' : 'dot-bad';
        const totalCobrado = proyectoCobradoMap.has(p.key) ? proyectoCobradoMap.get(p.key) : p.totalCobrado;
        return `
          <tr class="project-row ${isSel ? 'selected':''}" onclick="selectProyecto('${escapeHtmlAttr(p.key)}')">
            <td style="width:40px;"><span class="dot-status ${dotClass}"></span></td>
            <td>${escapeHtml(p.key)}</td>
            <td>${p.fechaCierre ? escapeHtml(formatDate(p.fechaCierre)) : '-'}</td>
            <td>${escapeHtml(p.cliente || '')}</td>
            <td>${escapeHtml(fmt(p.totalCotizado))}</td>
            <td>
              <input type="text" inputmode="decimal"
                     value="${escapeHtml(fmt(totalCobrado))}"
                     onclick="event.stopPropagation();"
                     onmousedown="event.stopPropagation();"
                     onfocus="event.stopPropagation(); this.value = parseMoney(this.value); this.select();"
                     onblur="handleCobradoBlur('${escapeHtmlAttr(p.key)}', this.value)">
            </td>
            <td>
              <div class="actions">
                <button class="btn btn-ghost" onclick="event.stopPropagation(); verAdjuntos('${escapeHtmlAttr(p.cotizacionId || '')}')">Adjuntos</button>
                <button class="btn btn-ghost" onclick="event.stopPropagation(); verCotizacion('${escapeHtmlAttr(p.cotizacionId || '')}')">Ver Cotizaci√≥n</button>
                <button class="btn btn-ghost" onclick="event.stopPropagation(); imprimirContrato('${escapeHtmlAttr(p.cotizacionId || '')}')">Imprimir contrato</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      pw.innerHTML = `
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th style="width:40px;">&nbsp;</th>
                <th>Nombre proyecto</th>
                <th>Fecha de cierre</th>
                <th>Cliente</th>
                <th>Precio cotizado</th>
                <th>Precio cobrado (manual)</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    function renderPartidas() {
      const pw = document.getElementById('partidas-wrapper');
      const title = document.getElementById('partidas-title');
      const subtitle = document.getElementById('partidas-subtitle');

      if (!selectedProyectoKey) {
        title.textContent = 'Partidas del proyecto';
        subtitle.textContent = 'Selecciona un proyecto para ver sus partidas.';
        pw.innerHTML = '<div class="empty"><span class="state-icon">‚ÑπÔ∏è</span>Selecciona un proyecto para ver sus partidas.</div>';
        return;
      }

      const proyecto = proyectos.find(p => p.key === selectedProyectoKey);
      if (!proyecto) {
        title.textContent = 'Partidas del proyecto';
        subtitle.textContent = 'Selecciona un proyecto para ver sus partidas.';
        pw.innerHTML = '<div class="empty"><span class="state-icon">‚ÑπÔ∏è</span>Selecciona un proyecto para ver sus partidas.</div>';
        return;
      }

      title.textContent = `Partidas del proyecto: ${proyecto.key}`;
      subtitle.textContent = `${proyecto.items.length} partida(s)`;

      if (!proyecto.items.length) {
        pw.innerHTML = '<div class="empty"><span class="state-icon">üìÅ</span>Este proyecto no tiene partidas.</div>';
        return;
      }

      const rows = proyecto.items.map(item => {
        const partidaId = item.id || item.partida_id || item.partida_nombre || item.partida;
        const nota = notesStore.get(partidaId) || '';
        return `
          <tr>
            <td style="width:170px;">
              <select class="state-select ${stateClass(item.estado)}" onmousedown="event.stopPropagation();" onchange="handleEstadoPartidaChange(event, '${escapeHtmlAttr(partidaId)}')">
                ${ESTADOS.map(st => `<option value="${st}" ${item.estado===st?'selected':''}>${labelEstado(st)}</option>`).join('')}
              </select>
            </td>
            <td>${escapeHtml(item.partida_nombre || item.partida || 'Partida')}</td>
            <td><input type="date" value="${item.fecha_venta_partida || ''}" onchange="handlePartidaInput('${escapeHtmlAttr(partidaId)}','fecha_venta_partida', this.value)"></td>
            <td><input type="date" value="${item.fecha_instalacion || ''}" onchange="handlePartidaInput('${escapeHtmlAttr(partidaId)}','fecha_instalacion', this.value)"></td>
            <td><input type="number" min="0" step="1000" value="${Number(item.precio_individual_estimado||0)}" onchange="handlePartidaInput('${escapeHtmlAttr(partidaId)}','precio_individual_estimado', this.value)"></td>
            <td>
              <button class="btn btn-ghost" onclick="openNotesModal('${escapeHtmlAttr(partidaId)}','${escapeHtmlAttr(selectedProyectoKey)}','${escapeHtmlAttr(proyecto.key)}')">Notas</button>
              ${nota ? `<span class="note-indicator">üìù</span>` : ''}
            </td>
          </tr>
        `;
      }).join('');

      pw.innerHTML = `
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Status</th>
                <th>Nombre partida</th>
                <th>Fecha de venta</th>
                <th>Fecha de instalaci√≥n</th>
                <th>Precio individual estimado</th>
                <th>Notas y obs</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
      applyStateStyles();
    }

    function renderResumen() {
      const rw = document.getElementById('resumen-wrapper');
      const title = document.getElementById('resumen-title');

      if (!selectedProyectoKey) {
        title.textContent = 'Resumen';
        rw.innerHTML = '<div class="empty"><span class="state-icon">‚ÑπÔ∏è</span>Selecciona un proyecto para ver el resumen.</div>';
        return;
      }
      const proyecto = proyectos.find(p => p.key === selectedProyectoKey);
      if (!proyecto) {
        title.textContent = 'Resumen';
        rw.innerHTML = '<div class="empty"><span class="state-icon">‚ÑπÔ∏è</span>Selecciona un proyecto para ver el resumen.</div>';
        return;
      }
      title.textContent = `Resumen del proyecto: ${proyecto.key}`;

      const totalCotizado = proyecto.totalCotizado || 0;
      const totalCobrado = proyectoCobradoMap.has(proyecto.key)
        ? proyectoCobradoMap.get(proyecto.key)
        : proyecto.totalCobrado || 0;

      const diffRaw = totalCobrado - totalCotizado;
      const diferencia = Math.abs(diffRaw) < 1e-6 ? 0 : diffRaw;
      const diffSign = diferencia > 0 ? '+' : (diferencia < 0 ? '‚àí' : '¬±');
      const diffClass = diferencia > 0 ? 'diff-pos' : (diferencia < 0 ? 'diff-neg' : 'diff-neutral');
      const diffAbs = Math.abs(diferencia);

      const motivoSel = motivoVariacionMap.get(proyecto.key) || '';
      const motivoAjusteIVA = motivoSel === 'Ajuste tributario (IVA u otros impuestos)';

      const total = totalCobrado;
      const subtotal = motivoAjusteIVA ? total : (total / 1.19);
      const iva = motivoAjusteIVA ? 0 : (total - subtotal);

      let optionsHtml = '';
      if (diferencia > 0) {
        optionsHtml = MOTIVOS_SUBIDA.map(m => `<option value="${escapeHtmlAttr(m)}" ${motivoSel===m?'selected':''}>${escapeHtml(m)}</option>`).join('');
      } else if (diferencia < 0) {
        optionsHtml = MOTIVOS_BAJADA.map(m => `<option value="${escapeHtmlAttr(m)}" ${motivoSel===m?'selected':''}>${escapeHtml(m)}</option>`).join('');
      }

      const diffPill = diferencia === 0
        ? `<span class="diff-chip diff-neutral"><span class="diff-sign">¬±</span><span>${escapeHtml(fmt(0))}</span></span>`
        : `<span class="diff-chip ${diffClass}"><span class="diff-sign">${diffSign}</span><span>${escapeHtml(fmt(diffAbs))}</span></span>`;

      const selectMotivos = diferencia === 0
        ? `<div class="resumen-label" style="margin-top:4px;">Sin diferencia</div>`
        : `
          <select onchange="handleMotivoChange('${escapeHtmlAttr(proyecto.key)}', this.value)">
            <option value="">Selecciona motivo</option>
            ${optionsHtml}
          </select>
        `;

      rw.innerHTML = `
        <div style="display:flex; flex-direction:column; gap:10px; font-size:14px;">
          <div class="resumen-row">
            <span class="resumen-label">Precio cotizado</span>
            <span class="resumen-value">${escapeHtml(fmt(totalCotizado))}</span>
          </div>
          <div class="resumen-row">
            <span class="resumen-label">Precio cobrado</span>
            <span class="resumen-value">${escapeHtml(fmt(totalCobrado))}</span>
          </div>
          <div class="resumen-row" style="align-items:center; gap:8px;">
            <span class="resumen-label">Diferencia</span>
            ${diffPill}
          </div>
          <div>
            <span class="resumen-label" style="display:block; margin-bottom:6px;">Motivo de la variaci√≥n</span>
            ${selectMotivos}
          </div>
          <hr class="resumen-divider">
          <div class="resumen-row"><span>Subtotal</span><span class="money">${escapeHtml(fmt(subtotal))}</span></div>
          <div class="resumen-row"><span>IVA (19%)</span><span class="money">${escapeHtml(fmt(iva))}</span></div>
          <hr class="resumen-divider">
          <div class="resumen-row" style="font-weight:800; font-size:15px;"><span>Total</span><span class="money">${escapeHtml(fmt(total))}</span></div>
        </div>
      `;
    }

    function selectProyecto(key) { selectedProyectoKey = key; renderProyectos(); renderPartidas(); renderResumen(); }

    function labelEstado(st) {
      switch(st) {
        case 'en_ejecucion': return 'En ejecuci√≥n';
        case 'completada': return 'Completada';
        case 'cancelada': return 'Cancelada';
        case 'postventa': return 'Postventa';
        default: return st;
      }
    }
    function stateClass(st) {
      switch(st) {
        case 'en_ejecucion': return 'st-en_ejecucion';
        case 'completada': return 'st-completada';
        case 'cancelada': return 'st-cancelada';
        case 'postventa': return 'st-postventa';
        default: return '';
      }
    }
    function applyStateStyles() {
      document.querySelectorAll('select.state-select').forEach(sel => {
        sel.classList.remove('st-en_ejecucion','st-completada','st-cancelada','st-postventa');
        sel.classList.add(stateClass(sel.value));
      });
    }

    async function persistVenta(partidaId, patch) {
      const row = ventasData.find(v => (v.id || v.partida_id || v.partida_nombre || v.partida) === partidaId);
      if (!row || !row.id) return false;
      try {
        const res = await window.supabaseClient.actualizarVenta(row.id, patch);
        if (!res?.success) throw new Error(res?.error || 'Error desconocido');
        return true;
      } catch (e) {
        console.warn('persistVenta error', e);
        return false;
      }
    }

    function handleEstadoPartidaChange(e, partidaId) {
      const nuevoEstado = e.target.value;
      ventasData = ventasData.map(v => {
        const idv = v.id || v.partida_id || v.partida_nombre || v.partida;
        return idv === partidaId ? { ...v, estado: nuevoEstado } : v;
      });
      persistVenta(partidaId, { estado: nuevoEstado });
      aplicarFiltros();
    }

    async function handleCobradoBlur(key, value) {
      const num = parseMoney(value);
      const proyecto = proyectos.find(p => p.key === key);
      if (proyecto && proyecto.items?.length) {
        const first = proyecto.items[0];
        const pid = first.id || first.partida_id || first.partida_nombre || first.partida;
        ventasData = ventasData.map(v => {
          const idv = v.id || v.partida_id || v.partida_nombre || v.partida;
          return idv === pid ? { ...v, total_venta: num } : v;
        });
        await persistVenta(pid, { total_venta: num });
      }
      proyectoCobradoMap.set(key, num);
      buildProyectos();
      renderProyectos();
      renderResumen();
    }

    function handlePartidaInput(partidaId, field, value) {
      ventasData = ventasData.map(v => {
        const idv = v.id || v.partida_id || v.partida_nombre || v.partida;
        if (idv === partidaId) {
          const patch = field === 'precio_individual_estimado' ? Number(value || 0) : value;
          persistVenta(partidaId, { [field]: patch });
          return { ...v, [field]: patch };
        }
        return v;
      });
      aplicarFiltros();
    }

    async function handleMotivoChange(proyectoKey, value) {
      motivoVariacionMap.set(proyectoKey, value);
      const proyecto = proyectos.find(p => p.key === proyectoKey);
      if (proyecto && proyecto.items?.length) {
        const first = proyecto.items[0];
        const pid = first.id || first.partida_id || first.partida_nombre || first.partida;
        ventasData = ventasData.map(v => {
          const idv = v.id || v.partida_id || v.partida_nombre || v.partida;
          return idv === pid ? { ...v, motivo_variacion: value } : v;
        });
        await persistVenta(pid, { motivo_variacion: value });
      }
      renderResumen();
    }

    function verCotizacion(id) { if (!id) return; window.location.href = `../cotizaciones/detalle.html?id=${id}`; }
    function verAdjuntos(id) { if (!id) return; window.location.href = `../cotizaciones/detalle.html?id=${id}#adjuntos`; }
    function imprimirContrato(id) { window.utils?.mostrarNotificacion?.('Imprimir contrato a√∫n no est√° disponible', 'info'); }

    function openNotesModal(partidaId, proyectoKey, proyectoNombre) {
      notesModalState = { partidaId, proyectoKey, proyectoNombre };
      const modal = document.getElementById('notes-modal');
      const textarea = document.getElementById('notes-textarea');
      const title = document.getElementById('notes-title');
      const partida = ventasData.find(v => (v.id || v.partida_id || v.partida_nombre || v.partida) === partidaId);
      const nombrePartida = partida?.partida_nombre || partida?.partida || 'Partida';
      title.textContent = `Observaciones ¬∑ ${proyectoNombre || proyectoKey} ¬∑ ${nombrePartida}`;
      textarea.value = notesStore.get(partidaId) || '';
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function closeNotesModal() {
      const modal = document.getElementById('notes-modal');
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      notesModalState = { partidaId: null, proyectoKey: null, proyectoNombre: '' };
    }
    function saveNotes() {
      const { partidaId } = notesModalState;
      if (!partidaId) { closeNotesModal(); return; }
      const textarea = document.getElementById('notes-textarea');
      const text = textarea.value.trim();
      notesStore.set(partidaId, text);
      closeNotesModal();
      renderPartidas();
    }

    function fmt(num) {
      if (num === null || num === undefined) return '$0';
      return new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 }).format(num);
    }
    function parseMoney(val) {
      if (typeof val === 'number') return val;
      const cleaned = String(val || '').replace(/[^0-9,-.]/g, '');
      const noThousand = cleaned.replace(/[.,](?=.*[0-9]{3}\b)/g, '');
      const n = Number(noThousand.replace(',', '.'));
      return Number.isFinite(n) ? Math.round(n) : 0;
    }
    function formatCliente(cli) {
      if (!cli) return '';
      if (typeof cli === 'string') {
        try { const o = JSON.parse(cli); return o.nombre || o.name || o.cliente || ''; }
        catch { return cli; }
      }
      if (typeof cli === 'object') return cli.nombre || cli.name || cli.cliente || '';
      return String(cli);
    }
    function formatDate(d) { try { return new Date(d).toLocaleDateString('es-CL'); } catch { return ''; } }

    function escapeHtml(str) {
      if (str === undefined || str === null) return '';
      return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeHtmlAttr(str) { return escapeHtml(str).replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }
  </script>
</body>
</html>
